<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEIS AI - Enhanced Data Integration Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0b0f14;
            --bg-soft: #121821;
            --card: #0f1520;
            --text: #e9edf3;
            --muted: #9ba7b4;
            --brand: #12d6df;
            --accent: #ffd15c;
            --ok: #1ec28b;
            --warn: #ffb020;
            --risk: #ff5c5c;
            --stroke: #1f2a38;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
            --radius: 14px;
            --radius-sm: 10px;
            --maxw: 1200px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(180deg, var(--bg), #0c1016 30%, var(--bg-soft));
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: var(--maxw);
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--stroke);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: radial-gradient(120% 120% at 20% 20%, var(--brand), #0cf, #035);
            box-shadow: 0 6px 18px rgba(18, 214, 223, 0.35), inset 0 0 20px rgba(255, 255, 255, 0.08);
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            color: var(--brand);
        }

        h1 {
            font-size: 32px;
            margin-bottom: 20px;
            color: var(--text);
        }

        h2 {
            font-size: 24px;
            margin: 30px 0 15px;
            color: var(--text);
        }

        h3 {
            font-size: 18px;
            margin: 20px 0 10px;
            color: var(--text);
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.45);
        }

        .api-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            border: 1px solid var(--stroke);
            background: linear-gradient(180deg, #111824, #0c121c);
            color: var(--text);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(180deg, var(--brand), #0fb7bf);
            color: #001518;
            border-color: transparent;
            box-shadow: 0 6px 24px rgba(18, 214, 223, 0.45);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .data-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .data-section {
                grid-template-columns: 1fr;
            }
            
            .api-controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }

        .data-container {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            height: 400px;
            overflow-y: auto;
        }

        .data-item {
            padding: 12px;
            border-bottom: 1px solid var(--stroke);
            transition: var(--transition);
        }

        .data-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .data-item:last-child {
            border-bottom: none;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background-color: var(--ok);
            box-shadow: 0 0 10px var(--ok);
        }

        .status-disconnected {
            background-color: var(--risk);
        }

        .status-connecting {
            background-color: var(--warn);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .map-container {
            height: 500px;
            margin-bottom: 30px;
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--stroke);
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .chart-container {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 30px;
            height: 400px;
        }

        .config-panel {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--muted);
            font-weight: 500;
        }

        input[type="text"], select {
            width: 100%;
            padding: 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--stroke);
            background: var(--bg-soft);
            color: var(--text);
            transition: var(--transition);
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 2px rgba(18, 214, 223, 0.2);
        }

        .risk-low { color: var(--ok); }
        .risk-medium { color: var(--warn); }
        .risk-high { color: var(--risk); }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--brand);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab {
            padding: 10px 20px;
            background: var(--bg-soft);
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: 1px solid var(--stroke);
            transition: var(--transition);
        }

        .tab.active {
            background: var(--brand);
            color: #001518;
            border-color: var(--brand);
        }

        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .sensor-card {
            background: var(--bg-soft);
            border-radius: var(--radius-sm);
            padding: 15px;
            border: 1px solid var(--stroke);
            transition: var(--transition);
        }

        .sensor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .sensor-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            color: var(--brand);
        }

        .insar-image {
            width: 100%;
            border-radius: var(--radius-sm);
            margin-bottom: 15px;
            border: 1px solid var(--stroke);
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        .preview-table th, .preview-table td {
            border: 1px solid var(--stroke);
            padding: 8px;
            text-align: left;
        }

        .preview-table th {
            background: var(--bg-soft);
            font-weight: 600;
        }

        .preview-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .risk-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .risk-badge.low { background: var(--ok); color: #000; }
        .risk-badge.medium { background: var(--warn); color: #000; }
        .risk-badge.high { background: var(--risk); color: #fff; }

        .upload-success {
            color: var(--ok);
            padding: 10px;
            background: rgba(30, 194, 139, 0.1);
            border-radius: 5px;
            border-left: 3px solid var(--ok);
        }

        .upload-error {
            color: var(--risk);
            padding: 10px;
            background: rgba(255, 92, 92, 0.1);
            border-radius: 5px;
            border-left: 3px solid var(--risk);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 1000;
            max-width: 400px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: rgba(30, 194, 139, 0.1);
            border-left: 4px solid var(--ok);
            color: var(--ok);
        }
        
        .notification.error {
            background: rgba(255, 92, 92, 0.1);
            border-left: 4px solid var(--risk);
            color: var(--risk);
        }
        
        .notification.info {
            background: rgba(18, 214, 223, 0.1);
            border-left: 4px solid var(--brand);
            color: var(--brand);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--muted);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--bg-soft);
            border-radius: var(--radius-sm);
            padding: 15px;
            text-align: center;
            border: 1px solid var(--stroke);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--brand);
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--muted);
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--stroke);
            background: var(--bg-soft);
            color: var(--text);
        }
        
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-controls .btn {
            padding: 8px 15px;
            font-size: 14px;
        }

        /* Enhanced Error Handling Styles */
        .error-state {
            text-align: center;
            padding: 30px 20px;
            color: var(--risk);
            background: rgba(255, 92, 92, 0.05);
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--risk);
            margin: 10px 0;
        }

        .error-details {
            background: var(--bg-soft);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
            text-align: left;
            display: none;
        }

        .error-details.show {
            display: block;
        }

        .retry-btn {
            background: var(--risk);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 5px;
        }

        .retry-btn:hover {
            background: #ff4040;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-detail {
            font-size: 12px;
            color: var(--muted);
            margin-left: 20px;
        }

        .api-error-log {
            max-height: 150px;
            overflow-y: auto;
            background: var(--bg-soft);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 11px;
            display: none;
        }

        .api-error-log.show {
            display: block;
        }

        .error-log-entry {
            border-bottom: 1px solid var(--stroke);
            padding: 5px 0;
        }

        .error-log-entry:last-child {
            border-bottom: none;
        }

        .error-time {
            color: var(--muted);
            font-size: 10px;
        }

        /* Preferences Panel Styles */
        .preferences-panel {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .preferences-panel.active {
            display: block;
        }

        .preferences-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .preferences-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--stroke);
            padding-bottom: 10px;
        }

        .pref-tab {
            padding: 8px 16px;
            background: var(--bg-soft);
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: 1px solid var(--stroke);
            transition: var(--transition);
            font-size: 14px;
        }

        .pref-tab.active {
            background: var(--brand);
            color: #001518;
            border-color: var(--brand);
        }

        .pref-content {
            display: none;
        }

        .pref-content.active {
            display: block;
        }

        .pref-section {
            margin-bottom: 20px;
        }

        .pref-section h4 {
            margin-bottom: 10px;
            color: var(--text);
            font-size: 16px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--brand);
        }

        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
        }

        .theme-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .theme-option {
            padding: 10px 15px;
            border: 1px solid var(--stroke);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            flex: 1;
        }

        .theme-option:hover {
            border-color: var(--brand);
        }

        .theme-option.active {
            border-color: var(--brand);
            background: rgba(18, 214, 223, 0.1);
        }

        .theme-preview {
            width: 100%;
            height: 40px;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .theme-dark .theme-preview {
            background: linear-gradient(90deg, #0b0f14, #121821);
        }

        .theme-blue .theme-preview {
            background: linear-gradient(90deg, #0d1b2a, #1b263b);
        }

        .theme-green .theme-preview {
            background: linear-gradient(90deg, #0d210d, #1b3b1b);
        }

        .auto-refresh-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .auto-refresh-controls input {
            width: 80px;
        }

        .reset-preferences {
            background: var(--risk);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        .reset-preferences:hover {
            background: #ff4040;
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .focus-visible {
            outline: 2px solid var(--brand);
            outline-offset: 2px;
        }

        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--brand);
            color: #001518;
            padding: 8px;
            border-radius: 4px;
            text-decoration: none;
            z-index: 10000;
            transition: top 0.3s;
        }

        .skip-link:focus {
            top: 6px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --bg: #000;
                --bg-soft: #111;
                --card: #222;
                --text: #fff;
                --muted: #ccc;
                --stroke: #444;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .loading {
                animation: none;
                border: 3px solid var(--brand);
                border-right-color: transparent;
            }
        }
    </style>
</head>
<body>
    <!-- Skip link for keyboard users -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Notification area with ARIA role -->
    <div class="notification" id="notification" role="alert" aria-live="assertive" aria-atomic="true"></div>
    
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon" aria-hidden="true"></div>
                <div class="logo-text">SEIS AI</div>
            </div>
            <h1>Enhanced Data Integration Dashboard</h1>
            <button id="preferencesToggle" class="btn" aria-expanded="false" aria-controls="preferencesPanel">
                <span aria-hidden="true">⚙️</span> Preferences
            </button>
        </header>

        <main id="main-content" tabindex="-1">
            <!-- Preferences Panel -->
            <section class="preferences-panel" id="preferencesPanel" aria-labelledby="preferencesHeading">
                <div class="preferences-header">
                    <h2 id="preferencesHeading">User Preferences</h2>
                    <button id="closePreferences" class="btn" aria-label="Close preferences panel">
                        <span aria-hidden="true">✕</span> Close
                    </button>
                </div>
                
                <div class="preferences-tabs" role="tablist" aria-label="Preferences categories">
                    <button class="pref-tab active" role="tab" aria-selected="true" aria-controls="general-tab" id="general-tab-btn">General</button>
                    <button class="pref-tab" role="tab" aria-selected="false" aria-controls="display-tab" id="display-tab-btn">Display</button>
                    <button class="pref-tab" role="tab" aria-selected="false" aria-controls="data-tab" id="data-tab-btn">Data & API</button>
                    <button class="pref-tab" role="tab" aria-selected="false" aria-controls="notifications-tab" id="notifications-tab-btn">Notifications</button>
                </div>
                
                <div class="pref-content active" id="general-tab" role="tabpanel" aria-labelledby="general-tab-btn" tabindex="0">
                    <div class="pref-section">
                        <h4>Dashboard Behavior</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="autoConnect" name="autoConnect">
                            <label for="autoConnect">Automatically connect to APIs on startup</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="rememberFilters" name="rememberFilters">
                            <label for="rememberFilters">Remember filter settings between sessions</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="autoRefresh" name="autoRefresh">
                            <label for="autoRefresh">Enable auto-refresh of data</label>
                        </div>
                        
                        <div class="auto-refresh-controls" id="autoRefreshControls" style="display: none;">
                            <label for="refreshInterval">Refresh interval (minutes):</label>
                            <input type="number" id="refreshInterval" min="1" max="60" value="5">
                        </div>
                    </div>
                    
                    <div class="pref-section">
                        <h4>Default View</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="collapseSidebar" name="collapseSidebar">
                            <label for="collapseSidebar">Collapse sidebar by default</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="startWithMap" name="startWithMap">
                            <label for="startWithMap">Start with map view expanded</label>
                        </div>
                    </div>
                </div>
                
                <div class="pref-content" id="display-tab" role="tabpanel" aria-labelledby="display-tab-btn" tabindex="0" hidden>
                    <div class="pref-section">
                        <h4>Theme Selection</h4>
                        <div class="theme-selector" role="radiogroup" aria-labelledby="theme-selection-label">
                            <span id="theme-selection-label" class="sr-only">Choose a color theme</span>
                            <div class="theme-option theme-dark active" data-theme="dark" role="radio" aria-checked="true" tabindex="0">
                                <div class="theme-preview" aria-hidden="true"></div>
                                <div>Dark Theme</div>
                            </div>
                            <div class="theme-option theme-blue" data-theme="blue" role="radio" aria-checked="false" tabindex="0">
                                <div class="theme-preview" aria-hidden="true"></div>
                                <div>Blue Theme</div>
                            </div>
                            <div class="theme-option theme-green" data-theme="green" role="radio" aria-checked="false" tabindex="0">
                                <div class="theme-preview" aria-hidden="true"></div>
                                <div>Green Theme</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pref-section">
                        <h4>Chart Display</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="smoothCharts" name="smoothCharts">
                            <label for="smoothCharts">Use smooth animations in charts</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="showGridlines" name="showGridlines">
                            <label for="showGridlines">Show chart gridlines</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="compactMode" name="compactMode">
                            <label for="compactMode">Use compact data display mode</label>
                        </div>
                    </div>
                </div>
                
                <div class="pref-content" id="data-tab" role="tabpanel" aria-labelledby="data-tab-btn" tabindex="0" hidden>
                    <div class="pref-section">
                        <h4>Data Preferences</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="cacheData" name="cacheData">
                            <label for="cacheData">Cache API responses for faster loading</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="highPrecision" name="highPrecision">
                            <label for="highPrecision">Use high precision data (slower)</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="saveDataExports" name="saveDataExports">
                            <label for="saveDataExports">Save data exports to downloads folder</label>
                        </div>
                    </div>
                    
                    <div class="pref-section">
                        <h4>API Connection</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="retryFailed" name="retryFailed">
                            <label for="retryFailed">Automatically retry failed API calls</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="showApiErrors" name="showApiErrors">
                            <label for="showApiErrors">Show detailed API error messages</label>
                        </div>
                    </div>
                </div>
                
                <div class="pref-content" id="notifications-tab" role="tabpanel" aria-labelledby="notifications-tab-btn" tabindex="0" hidden>
                    <div class="pref-section">
                        <h4>Notification Preferences</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="notifyErrors" name="notifyErrors">
                            <label for="notifyErrors">Notify on API connection errors</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="notifyHighRisk" name="notifyHighRisk">
                            <label for="notifyHighRisk">Notify on high-risk seismic events</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="notifyDataUpdates" name="notifyDataUpdates">
                            <label for="notifyDataUpdates">Notify when new data is available</label>
                        </div>
                    </div>
                    
                    <div class="pref-section">
                        <h4>Notification Display</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="showNotifications" name="showNotifications">
                            <label for="showNotifications">Show notification toasts</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="soundNotifications" name="soundNotifications">
                            <label for="soundNotifications">Play sound for important notifications</label>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button id="savePreferences" class="btn btn-primary">Save Preferences</button>
                    <button id="resetPreferences" class="reset-preferences">Reset to Defaults</button>
                </div>
            </section>

            <section class="card">
                <h2>API Configuration</h2>
                <div class="config-panel">
                    <div class="form-group">
                        <label for="usgsApiKey">USGS API Key (Optional)</label>
                        <input type="text" id="usgsApiKey" placeholder="Enter your USGS API key" aria-describedby="usgsApiKeyHelp">
                        <div id="usgsApiKeyHelp" class="sr-only">Optional API key for accessing USGS earthquake data</div>
                    </div>
                    <div class="form-group">
                        <label for="weatherApiKey">OpenWeatherMap API Key</label>
                        <input type="text" id="weatherApiKey" placeholder="Enter your OpenWeatherMap API key" aria-describedby="weatherApiKeyHelp">
                        <div id="weatherApiKeyHelp" class="sr-only">Required API key for accessing weather data</div>
                    </div>
                    <div class="form-group">
                        <label for="nationalGeoApiKey">National Geological Survey API Key</label>
                        <input type="text" id="nationalGeoApiKey" placeholder="Enter your national geological API key" aria-describedby="nationalGeoApiKeyHelp">
                        <div id="nationalGeoApiKeyHelp" class="sr-only">API key for accessing national geological survey data</div>
                    </div>
                    <div class="form-group">
                        <label for="satelliteApiKey">Satellite Data API Key</label>
                        <input type="text" id="satelliteApiKey" placeholder="Enter your satellite data API key" aria-describedby="satelliteApiKeyHelp">
                        <div id="satelliteApiKeyHelp" class="sr-only">API key for accessing satellite and InSAR data</div>
                    </div>
                    <button id="saveConfig" class="btn btn-primary">Save Configuration</button>
                </div>
            </section>

            <!-- Enhanced API Status Section -->
            <section class="card" aria-labelledby="apiStatusHeading">
                <h2 id="apiStatusHeading">API Status & Error Log</h2>
                <div class="api-controls">
                    <button id="connectAll" class="btn btn-primary">Connect to All APIs</button>
                    <button id="retryFailedBtn" class="btn" style="display: none;">Retry Failed Connections</button>
                    <button id="clearErrors" class="btn">Clear Error Log</button>
                    <button id="getSeismicData" class="btn">Get Seismic Data</button>
                    <button id="getWeatherData" class="btn">Get Weather Data</button>
                    <button id="getGeoData" class="btn">Get Geological Data</button>
                    <button id="getSatelliteData" class="btn">Get Satellite Data</button>
                    <button id="getSensorData" class="btn">Get Sensor Data</button>
                </div>
                <div id="apiStatus" role="status" aria-live="polite">
                    <div class="data-item">
                        <span class="status-indicator status-disconnected" aria-label="Disconnected"></span>
                        USGS API: Disconnected
                    </div>
                    <div class="data-item">
                        <span class="status-indicator status-disconnected" aria-label="Disconnected"></span>
                        OpenWeatherMap API: Disconnected
                    </div>
                    <div class="data-item">
                        <span class="status-indicator status-disconnected" aria-label="Disconnected"></span>
                        National Geological Survey API: Disconnected
                    </div>
                    <div class="data-item">
                        <span class="status-indicator status-disconnected" aria-label="Disconnected"></span>
                        Satellite Data API: Disconnected
                    </div>
                    <div class="data-item">
                        <span class="status-indicator status-disconnected" aria-label="Disconnected"></span>
                        Mine Sensor Network: Disconnected
                    </div>
                    <div class="data-item">
                        <span class="status-indicator status-disconnected" aria-label="Not loaded"></span>
                        Rockfall Data: Not Loaded
                    </div>
                </div>
                <div id="apiErrorLog" class="api-error-log" role="log" aria-label="API Error Log">
                    <h4>Recent Errors</h4>
                    <div id="errorLogContent"></div>
                </div>
            </section>

            <section class="card" aria-labelledby="dashboardStatsHeading">
                <h2 id="dashboardStatsHeading">Dashboard Summary</h2>
                <div class="stats-grid" id="dashboardStats" aria-live="polite">
                    <!-- Stats will be populated by JavaScript -->
                </div>
            </section>

            <section class="data-section">
                <div class="card" aria-labelledby="seismicDataHeading">
                    <h2 id="seismicDataHeading">Seismic Data</h2>
                    <div class="search-box">
                        <label for="seismicSearch" class="sr-only">Search seismic events</label>
                        <input type="text" id="seismicSearch" placeholder="Search seismic events..." aria-describedby="seismicSearchHelp">
                        <div id="seismicSearchHelp" class="sr-only">Type to filter seismic events by location name</div>
                    </div>
                    <div class="filter-controls" role="group" aria-label="Filter seismic events by risk level">
                        <button class="btn active" data-filter="all" aria-pressed="true">All</button>
                        <button class="btn" data-filter="low" aria-pressed="false">Low Risk</button>
                        <button class="btn" data-filter="medium" aria-pressed="false">Medium Risk</button>
                        <button class="btn" data-filter="high" aria-pressed="false">High Risk</button>
                    </div>
                    <div class="data-container" id="seismicData" aria-live="polite">
                        <div class="empty-state">
                            <span aria-hidden="true">🌋</span>
                            <p>No seismic data available. Click "Get Seismic Data" to load information.</p>
                        </div>
                    </div>
                </div>

                <div class="card" aria-labelledby="weatherDataHeading">
                    <h2 id="weatherDataHeading">Weather Data</h2>
                    <div class="data-container" id="weatherData" aria-live="polite">
                        <div class="empty-state">
                            <span aria-hidden="true">🌤️</span>
                            <p>No weather data available. Click "Get Weather Data" to load information.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="data-section">
                <div class="card" aria-labelledby="geoDataHeading">
                    <h2 id="geoDataHeading">Geological Survey Data</h2>
                    <div class="data-container" id="geoData" aria-live="polite">
                        <div class="empty-state">
                            <span aria-hidden="true">⛰️</span>
                            <p>No geological data available. Click "Get Geological Data" to load information.</p>
                        </div>
                    </div>
                </div>

                <div class="card" aria-labelledby="satelliteDataHeading">
                    <h2 id="satelliteDataHeading">Satellite & InSAR Data</h2>
                    <div class="tab-container" role="tablist" aria-label="Satellite data types">
                        <button class="tab active" role="tab" aria-selected="true" aria-controls="insar-tab" id="insar-tab-btn">InSAR Data</button>
                        <button class="tab" role="tab" aria-selected="false" aria-controls="satellite-tab" id="satellite-tab-btn">Satellite Imagery</button>
                    </div>
                    <div class="data-container" id="satelliteData">
                        <div class="tab-content active" id="insar-tab" role="tabpanel" aria-labelledby="insar-tab-btn" tabindex="0">
                            <div class="empty-state">
                                <span aria-hidden="true">🛰️</span>
                                <p>No InSAR data available. Click "Get Satellite Data" to load information.</p>
                            </div>
                        </div>
                        <div class="tab-content" id="satellite-tab" role="tabpanel" aria-labelledby="satellite-tab-btn" tabindex="0" hidden>
                            <div class="empty-state">
                                <span aria-hidden="true">📡</span>
                                <p>No satellite imagery available. Click "Get Satellite Data" to load information.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="card" aria-labelledby="sensorDataHeading">
                <h2 id="sensorDataHeading">Mine Sensor Data</h2>
                <div class="data-container" id="sensorData" aria-live="polite">
                    <div class="empty-state">
                        <span aria-hidden="true">📊</span>
                        <p>No sensor data available. Click "Get Sensor Data" to load information.</p>
                    </div>
                </div>
            </section>

            <section class="card" aria-labelledby="rockfallDataHeading">
                <h2 id="rockfallDataHeading">Rockfall Data</h2>
                <div class="api-controls">
                    <button id="getRockfallData" class="btn">Get Rockfall Data</button>
                    <button id="uploadRockfallData" class="btn">Upload Rockfall Data</button>
                </div>
                <div class="data-container" id="rockfallData" aria-live="polite">
                    <div class="empty-state">
                        <span aria-hidden="true">🪨</span>
                        <p>No rockfall data available. Click "Get Rockfall Data" to load information.</p>
                    </div>
                </div>
            </section>

            <section class="card" aria-labelledby="rockfallChartHeading">
                <h2 id="rockfallChartHeading">Rockfall Risk Analysis</h2>
                <div class="chart-container">
                    <canvas id="rockfallChart" aria-label="Rockfall risk analysis chart showing risk scores, rainfall, and crack width over time"></canvas>
                </div>
            </section>

            <section class="card" aria-labelledby="uploadDataHeading">
                <h2 id="uploadDataHeading">Upload Rockfall Dataset</h2>
                <div class="config-panel">
                    <div class="form-group">
                        <label for="mineSelect">Select Mine for Data Association:</label>
                        <select id="mineSelect" class="select" aria-describedby="mineSelectHelp">
                            <option value="">Loading mines...</option>
                        </select>
                        <div id="mineSelectHelp" class="sr-only">Select which mine this rockfall data is associated with</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="csvFile">Select CSV File:</label>
                        <input type="file" id="csvFile" accept=".csv" style="display: none" aria-describedby="csvFileHelp">
                        <div id="csvFileHelp" class="sr-only">Select a CSV file containing rockfall data to upload</div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button type="button" id="browseBtn" class="btn">Browse CSV File</button>
                            <span id="fileName" style="color: var(--muted);">No file selected</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>CSV Format Expected:</label>
                        <div style="background: var(--bg-soft); padding: 10px; border-radius: 5px; font-size: 12px; margin-top: 5px;">
                            <code>Rainfall(mm),Temperature(°C),Slope_Angle(deg),Seismic_Magnitude,Crack_Width(mm),Risk_Score,Risk_Level</code>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="uploadCsvBtn" class="btn btn-primary" disabled>Upload and Process CSV</button>
                        <button id="previewCsvBtn" class="btn" disabled>Preview Data</button>
                    </div>
                </div>
                
                <!-- Preview Table -->
                <div id="previewSection" style="display: none; margin-top: 20px;" aria-live="polite">
                    <h3>Data Preview (First 10 rows)</h3>
                    <div id="previewTable" style="overflow-x: auto;"></div>
                    <div style="margin-top: 10px;">
                        <button id="confirmUploadBtn" class="btn btn-primary" style="display: none;">Confirm Upload</button>
                        <button id="cancelPreviewBtn" class="btn">Cancel</button>
                    </div>
                </div>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" style="display: none; margin-top: 20px;" aria-live="polite">
                    <h3>Upload Progress</h3>
                    <div style="background: var(--bg-soft); border-radius: 5px; padding: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Processing data...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div style="background: var(--stroke); height: 10px; border-radius: 5px; overflow: hidden;">
                            <div id="progressBar" style="background: var(--brand); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    <div id="uploadStatus" style="margin-top: 10px;"></div>
                </div>
            </section>

            <section class="card" aria-labelledby="mapHeading">
                <h2 id="mapHeading">Seismic Activity Map</h2>
                <div class="map-container">
                    <div id="map" aria-label="Interactive map showing seismic activity locations" role="application" tabindex="0"></div>
                </div>
            </section>

            <section class="card" aria-labelledby="riskChartHeading">
                <h2 id="riskChartHeading">Risk Assessment Chart</h2>
                <div class="chart-container">
                    <canvas id="riskChart" aria-label="Risk assessment chart showing distribution of mines by risk level"></canvas>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Enhanced Error Types
        const ErrorTypes = {
            NETWORK: 'NETWORK_ERROR',
            API: 'API_ERROR',
            AUTH: 'AUTHENTICATION_ERROR',
            PARSE: 'PARSE_ERROR',
            TIMEOUT: 'TIMEOUT_ERROR',
            UNKNOWN: 'UNKNOWN_ERROR'
        };

        // Enhanced Application Configuration
        const CONFIG = {
            API: {
                USGS: {
                    baseUrl: 'https://earthquake.usgs.gov/fdsnws/event/1/query',
                    defaultParams: {
                        format: 'geojson',
                        limit: 20,
                        orderby: 'time'
                    }
                },
                OPEN_WEATHER: {
                    baseUrl: 'https://api.openweathermap.org/data/2.5',
                    endpoints: {
                        current: '/weather',
                        forecast: '/forecast',
                        onecall: '/onecall'
                    }
                },
                ROCKFALL: {
                    baseUrl: '/api',
                    endpoints: {
                        data: '/rockfall-data',
                        upload: '/rockfall-data',
                        bulk: '/rockfall-data/bulk'
                    }
                },
                RETRY: {
                    maxRetries: 3,
                    retryDelay: 2000,
                    timeout: 10000
                }
            },
            MINE_LOCATIONS: [
                { name: 'Chuquicamata Copper Mine', lat: -22.3, lon: -68.9 },
                { name: 'Escondida Copper Mine', lat: -24.27, lon: -69.08 },
                { name: 'Grasberg Mine', lat: -4.06, lon: 137.11 },
                { name: 'Super Pit Gold Mine', lat: -30.75, lon: 121.47 }
            ],
            RISK_THRESHOLDS: {
                LOW: 4.0,
                MEDIUM: 5.0
            },
            // Default user preferences
            DEFAULT_PREFERENCES: {
                general: {
                    autoConnect: false,
                    rememberFilters: true,
                    autoRefresh: false,
                    refreshInterval: 5,
                    collapseSidebar: false,
                    startWithMap: true
                },
                display: {
                    theme: 'dark',
                    smoothCharts: true,
                    showGridlines: true,
                    compactMode: false
                },
                data: {
                    cacheData: true,
                    highPrecision: false,
                    saveDataExports: true,
                    retryFailed: true,
                    showApiErrors: true
                },
                notifications: {
                    notifyErrors: true,
                    notifyHighRisk: true,
                    notifyDataUpdates: false,
                    showNotifications: true,
                    soundNotifications: false
                },
                uiState: {
                    seismicFilter: 'all',
                    seismicSearchTerm: '',
                    satelliteTab: 'insar',
                    mapView: { lat: 20, lng: 0, zoom: 2 },
                    selectedMineId: ''
                }
            }
        };

        // Enhanced Application State with Error Tracking and Preferences
        const AppState = {
            apiKeys: {
                usgs: '',
                openWeather: '',
                nationalGeo: '',
                satellite: ''
            },
            connections: {
                usgs: false,
                openWeather: false,
                nationalGeo: false,
                satellite: false,
                mineSensors: false,
                rockfall: false
            },
            data: {
                seismic: [],
                weather: [],
                geo: [],
                satellite: {},
                sensor: {},
                rockfall: []
            },
            ui: {
                map: null,
                riskChart: null,
                rockfallChart: null,
                activeFilters: {
                    seismic: 'all'
                }
            },
            errors: {
                recent: [],
                counts: {
                    usgs: 0,
                    openWeather: 0,
                    nationalGeo: 0,
                    satellite: 0,
                    mineSensors: 0,
                    rockfall: 0
                },
                retryAttempts: {}
            },
            // User preferences
            preferences: JSON.parse(JSON.stringify(CONFIG.DEFAULT_PREFERENCES)),
            // Auto-refresh interval ID
            autoRefreshInterval: null
        };

        // Data Persistence Manager
        const DataPersistence = {
            // Save data to local storage
            saveToStorage: function(key, data) {
                try {
                    localStorage.setItem(`seisai_${key}`, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('Error saving to local storage:', error);
                    return false;
                }
            },

            // Load data from local storage
            loadFromStorage: function(key) {
                try {
                    const data = localStorage.getItem(`seisai_${key}`);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('Error loading from local storage:', error);
                    return null;
                }
            },

            // Save API keys
            saveApiKeys: function() {
                return this.saveToStorage('api_keys', AppState.apiKeys);
            },

            // Load API keys
            loadApiKeys: function() {
                const keys = this.loadFromStorage('api_keys');
                if (keys) {
                    AppState.apiKeys = { ...AppState.apiKeys, ...keys };
                    return true;
                }
                return false;
            },

            // Save user preferences
            savePreferences: function() {
                return this.saveToStorage('preferences', AppState.preferences);
            },

            // Load user preferences
            loadPreferences: function() {
                const prefs = this.loadFromStorage('preferences');
                if (prefs) {
                    // Merge with defaults to ensure all properties exist
                    AppState.preferences = this.mergeDeep(CONFIG.DEFAULT_PREFERENCES, prefs);
                    return true;
                }
                return false;
            },

            // Save UI state
            saveUIState: function() {
                return this.saveToStorage('ui_state', AppState.preferences.uiState);
            },

            // Load UI state
            loadUIState: function() {
                const uiState = this.loadFromStorage('ui_state');
                if (uiState) {
                    AppState.preferences.uiState = { ...AppState.preferences.uiState, ...uiState };
                    return true;
                }
                return false;
            },

            // Save specific data sets (for caching)
            saveData: function(key, data) {
                if (AppState.preferences.data.cacheData) {
                    const cacheData = {
                        data: data,
                        timestamp: Date.now()
                    };
                    return this.saveToStorage(`data_${key}`, cacheData);
                }
                return false;
            },

            // Load cached data if not expired
            loadData: function(key, maxAge = 5 * 60 * 1000) { // Default 5 minutes
                if (AppState.preferences.data.cacheData) {
                    const cacheData = this.loadFromStorage(`data_${key}`);
                    if (cacheData && cacheData.timestamp) {
                        const age = Date.now() - cacheData.timestamp;
                        if (age < maxAge) {
                            return cacheData.data;
                        }
                    }
                }
                return null;
            },

            // Clear all stored data
            clearAllData: function() {
                try {
                    const keys = Object.keys(localStorage).filter(key => key.startsWith('seisai_'));
                    keys.forEach(key => localStorage.removeItem(key));
                    return true;
                } catch (error) {
                    console.error('Error clearing local storage:', error);
                    return false;
                }
            },

            // Deep merge utility function
            mergeDeep: function(target, source) {
                const output = Object.assign({}, target);
                if (this.isObject(target) && this.isObject(source)) {
                    Object.keys(source).forEach(key => {
                        if (this.isObject(source[key])) {
                            if (!(key in target))
                                Object.assign(output, { [key]: source[key] });
                            else
                                output[key] = this.mergeDeep(target[key], source[key]);
                        } else {
                            Object.assign(output, { [key]: source[key] });
                        }
                    });
                }
                return output;
            },

            // Check if value is an object
            isObject: function(item) {
                return item && typeof item === 'object' && !Array.isArray(item);
            }
        };

        // Enhanced Error Handling Utility
        const ErrorHandler = {
            // Log error with context
            logError: function(errorType, source, error, context = {}) {
                const errorEntry = {
                    id: Date.now() + Math.random(),
                    type: errorType,
                    source: source,
                    message: error.message || error.toString(),
                    timestamp: new Date().toISOString(),
                    context: context,
                    stack: error.stack
                };

                // Add to recent errors (keep last 20)
                AppState.errors.recent.unshift(errorEntry);
                if (AppState.errors.recent.length > 20) {
                    AppState.errors.recent.pop();
                }

                // Update error counts
                if (AppState.errors.counts[source] !== undefined) {
                    AppState.errors.counts[source]++;
                }

                // Update retry attempts
                if (!AppState.errors.retryAttempts[source]) {
                    AppState.errors.retryAttempts[source] = 0;
                }

                console.error(`[${errorType}] ${source}:`, error, context);
                this.updateErrorDisplay();
            },

            // Get error count for a source
            getErrorCount: function(source) {
                return AppState.errors.counts[source] || 0;
            },

            // Clear errors for a specific source or all
            clearErrors: function(source = null) {
                if (source) {
                    AppState.errors.recent = AppState.errors.recent.filter(error => error.source !== source);
                    AppState.errors.counts[source] = 0;
                } else {
                    AppState.errors.recent = [];
                    Object.keys(AppState.errors.counts).forEach(key => {
                        AppState.errors.counts[key] = 0;
                    });
                }
                this.updateErrorDisplay();
            },

            // Update error display in UI
            updateErrorDisplay: function() {
                const errorLog = document.getElementById('errorLogContent');
                const apiErrorLog = document.getElementById('apiErrorLog');
                
                if (AppState.errors.recent.length === 0) {
                    errorLog.innerHTML = '<div class="error-log-entry">No recent errors</div>';
                    apiErrorLog.classList.remove('show');
                    return;
                }

                apiErrorLog.classList.add('show');
                
                errorLog.innerHTML = AppState.errors.recent.slice(0, 10).map(error => `
                    <div class="error-log-entry">
                        <div class="error-time">${new Date(error.timestamp).toLocaleTimeString()}</div>
                        <strong>${error.source}</strong>: ${error.message}
                        ${error.context.url ? `<br><small>URL: ${error.context.url}</small>` : ''}
                    </div>
                `).join('');
            },

            // Create user-friendly error message
            getUserFriendlyMessage: function(errorType, error, source) {
                const baseMessages = {
                    [ErrorTypes.NETWORK]: `Network connection failed for ${source}`,
                    [ErrorTypes.API]: `API error occurred with ${source}`,
                    [ErrorTypes.AUTH]: `Authentication failed for ${source}`,
                    [ErrorTypes.PARSE]: `Failed to parse response from ${source}`,
                    [ErrorTypes.TIMEOUT]: `Request timeout for ${source}`,
                    [ErrorTypes.UNKNOWN]: `An unexpected error occurred with ${source}`
                };

                let message = baseMessages[errorType] || baseMessages[ErrorTypes.UNKNOWN];
                
                // Add specific details if available
                if (error.message && errorType !== ErrorTypes.UNKNOWN) {
                    message += `: ${error.message}`;
                }

                return message;
            },

            // Determine error type from response/error
            classifyError: function(error, response = null) {
                if (error.name === 'TimeoutError' || error.code === 'ETIMEDOUT') {
                    return ErrorTypes.TIMEOUT;
                }
                
                if (error.name === 'NetworkError' || !navigator.onLine) {
                    return ErrorTypes.NETWORK;
                }
                
                if (response) {
                    if (response.status === 401 || response.status === 403) {
                        return ErrorTypes.AUTH;
                    }
                    if (response.status >= 400 && response.status < 500) {
                        return ErrorTypes.API;
                    }
                    if (response.status >= 500) {
                        return ErrorTypes.NETWORK; // Server error
                    }
                }
                
                if (error instanceof SyntaxError) {
                    return ErrorTypes.PARSE;
                }
                
                return ErrorTypes.UNKNOWN;
            }
        };

        // Accessibility Manager
        const AccessibilityManager = {
            // Initialize accessibility features
            init: function() {
                this.setupKeyboardNavigation();
                this.setupFocusManagement();
                this.setupAriaLiveRegions();
                this.setupReducedMotionSupport();
            },

            // Setup keyboard navigation
            setupKeyboardNavigation: function() {
                // Add keyboard event listeners for custom components
                document.addEventListener('keydown', (e) => {
                    // Handle tab key navigation for custom tabs
                    if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                        const activeTab = document.querySelector('[role="tab"][aria-selected="true"]');
                        if (activeTab && activeTab.parentElement.getAttribute('role') === 'tablist') {
                            this.handleTabNavigation(e, activeTab);
                        }
                    }

                    // Handle enter/space for custom buttons and controls
                    if ((e.key === 'Enter' || e.key === ' ') && e.target.getAttribute('role') === 'button') {
                        e.preventDefault();
                        e.target.click();
                    }
                });

                // Add focus styles for keyboard navigation
                document.addEventListener('keyup', (e) => {
                    if (e.key === 'Tab') {
                        document.body.classList.add('keyboard-navigation');
                    }
                });

                document.addEventListener('mousedown', () => {
                    document.body.classList.remove('keyboard-navigation');
                });
            },

            // Handle tab navigation with arrow keys
            handleTabNavigation: function(e, activeTab) {
                e.preventDefault();
                const tablist = activeTab.parentElement;
                const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
                const currentIndex = tabs.indexOf(activeTab);

                let nextIndex;
                if (e.key === 'ArrowRight') {
                    nextIndex = (currentIndex + 1) % tabs.length;
                } else if (e.key === 'ArrowLeft') {
                    nextIndex = (currentIndex - 1 + tabs.length) % tabs.length;
                }

                if (nextIndex !== undefined) {
                    this.activateTab(tabs[nextIndex]);
                }
            },

            // Activate a tab and its corresponding panel
            activateTab: function(tab) {
                // Deactivate all tabs in the same tablist
                const tablist = tab.parentElement;
                const tabs = tablist.querySelectorAll('[role="tab"]');
                tabs.forEach(t => {
                    t.setAttribute('aria-selected', 'false');
                    t.classList.remove('active');
                });

                // Hide all tabpanels in the same container
                const container = tab.closest('.card, .preferences-panel');
                const tabpanels = container.querySelectorAll('[role="tabpanel"]');
                tabpanels.forEach(panel => {
                    panel.hidden = true;
                    panel.classList.remove('active');
                });

                // Activate the selected tab
                tab.setAttribute('aria-selected', 'true');
                tab.classList.add('active');

                // Show the corresponding tabpanel
                const tabpanelId = tab.getAttribute('aria-controls');
                const tabpanel = document.getElementById(tabpanelId);
                if (tabpanel) {
                    tabpanel.hidden = false;
                    tabpanel.classList.add('active');
                    // Focus the tabpanel for keyboard users
                    tabpanel.focus();
                }
            },

            // Setup focus management
            setupFocusManagement: function() {
                // Trap focus in modal dialogs
                this.setupFocusTrap();

                // Return focus to previously focused element when closing modals
                this.setupFocusReturn();
            },

            // Setup focus trap for modal dialogs
            setupFocusTrap: function() {
                // This would be implemented for modal dialogs if added
            },

            // Setup focus return when closing modals
            setupFocusReturn: function() {
                // This would be implemented for modal dialogs if added
            },

            // Setup ARIA live regions for dynamic content
            setupAriaLiveRegions: function() {
                // Already implemented in HTML with aria-live attributes
            },

            // Setup reduced motion support
            setupReducedMotionSupport: function() {
                // CSS already handles this with prefers-reduced-motion media query
            },

            // Announce changes to screen readers
            announce: function(message, priority = 'polite') {
                // Create or update an aria-live region
                let liveRegion = document.getElementById('a11y-announcements');
                if (!liveRegion) {
                    liveRegion = document.createElement('div');
                    liveRegion.id = 'a11y-announcements';
                    liveRegion.setAttribute('aria-live', priority);
                    liveRegion.setAttribute('aria-atomic', 'true');
                    liveRegion.className = 'sr-only';
                    document.body.appendChild(liveRegion);
                }

                // Update the content to trigger announcement
                liveRegion.textContent = message;

                // Clear the message after a short delay
                setTimeout(() => {
                    liveRegion.textContent = '';
                }, 1000);
            },

            // Update button states for accessibility
            updateButtonState: function(button, state) {
                if (state === 'loading') {
                    button.setAttribute('aria-disabled', 'true');
                    button.setAttribute('aria-label', button.textContent + ', loading');
                } else {
                    button.removeAttribute('aria-disabled');
                    button.removeAttribute('aria-label');
                }
            }
        };

        // Preferences Manager
        const PreferencesManager = {
            // Initialize preferences
            init: function() {
                this.loadPreferences();
                this.setupEventListeners();
                this.applyPreferences();
            },

            // Load preferences from storage
            loadPreferences: function() {
                if (DataPersistence.loadPreferences()) {
                    console.log('Preferences loaded from storage');
                }
                
                // Also load UI state
                DataPersistence.loadUIState();
            },

            // Save preferences to storage
            savePreferences: function() {
                if (DataPersistence.savePreferences()) {
                    DataPersistence.saveUIState();
                    console.log('Preferences saved to storage');
                    return true;
                }
                return false;
            },

            // Apply preferences to UI
            applyPreferences: function() {
                this.applyGeneralPreferences();
                this.applyDisplayPreferences();
                this.applyDataPreferences();
                this.applyNotificationPreferences();
                this.applyUIState();
                
                // Setup auto-refresh if enabled
                this.setupAutoRefresh();
            },

            // Apply general preferences
            applyGeneralPreferences: function() {
                const prefs = AppState.preferences.general;
                
                // Set checkbox states
                this.setCheckboxState('autoConnect', prefs.autoConnect);
                this.setCheckboxState('rememberFilters', prefs.rememberFilters);
                this.setCheckboxState('autoRefresh', prefs.autoRefresh);
                this.setCheckboxState('collapseSidebar', prefs.collapseSidebar);
                this.setCheckboxState('startWithMap', prefs.startWithMap);
                
                // Set refresh interval
                document.getElementById('refreshInterval').value = prefs.refreshInterval;
                
                // Show/hide auto-refresh controls
                this.toggleAutoRefreshControls(prefs.autoRefresh);
                
                // Auto-connect to APIs if enabled
                if (prefs.autoConnect) {
                    setTimeout(() => {
                        UI.connectToAllApis();
                    }, 1000);
                }
            },

            // Apply display preferences
            applyDisplayPreferences: function() {
                const prefs = AppState.preferences.display;
                
                // Set theme
                this.applyTheme(prefs.theme);
                
                // Set checkbox states
                this.setCheckboxState('smoothCharts', prefs.smoothCharts);
                this.setCheckboxState('showGridlines', prefs.showGridlines);
                this.setCheckboxState('compactMode', prefs.compactMode);
                
                // Apply chart preferences
                this.applyChartPreferences();
            },

            // Apply data preferences
            applyDataPreferences: function() {
                const prefs = AppState.preferences.data;
                
                // Set checkbox states
                this.setCheckboxState('cacheData', prefs.cacheData);
                this.setCheckboxState('highPrecision', prefs.highPrecision);
                this.setCheckboxState('saveDataExports', prefs.saveDataExports);
                this.setCheckboxState('retryFailed', prefs.retryFailed);
                this.setCheckboxState('showApiErrors', prefs.showApiErrors);
            },

            // Apply notification preferences
            applyNotificationPreferences: function() {
                const prefs = AppState.preferences.notifications;
                
                // Set checkbox states
                this.setCheckboxState('notifyErrors', prefs.notifyErrors);
                this.setCheckboxState('notifyHighRisk', prefs.notifyHighRisk);
                this.setCheckboxState('notifyDataUpdates', prefs.notifyDataUpdates);
                this.setCheckboxState('showNotifications', prefs.showNotifications);
                this.setCheckboxState('soundNotifications', prefs.soundNotifications);
            },

            // Apply UI state
            applyUIState: function() {
                const uiState = AppState.preferences.uiState;
                
                // Apply seismic filter
                if (uiState.seismicFilter) {
                    AppState.ui.activeFilters.seismic = uiState.seismicFilter;
                    const activeFilterBtn = document.querySelector(`.filter-controls .btn[data-filter="${uiState.seismicFilter}"]`);
                    if (activeFilterBtn) {
                        document.querySelectorAll('.filter-controls .btn').forEach(btn => {
                            btn.classList.remove('active');
                            btn.setAttribute('aria-pressed', 'false');
                        });
                        activeFilterBtn.classList.add('active');
                        activeFilterBtn.setAttribute('aria-pressed', 'true');
                    }
                }
                
                // Apply seismic search term
                if (uiState.seismicSearchTerm) {
                    document.getElementById('seismicSearch').value = uiState.seismicSearchTerm;
                    UI.filterSeismicData(uiState.seismicSearchTerm);
                }
                
                // Apply satellite tab
                if (uiState.satelliteTab) {
                    const tab = document.querySelector(`.tab[aria-controls="${uiState.satelliteTab}-tab"]`);
                    if (tab) {
                        this.activateTab(tab);
                    }
                }
                
                // Apply map view if map is initialized
                if (uiState.mapView && AppState.ui.map) {
                    AppState.ui.map.setView([uiState.mapView.lat, uiState.mapView.lng], uiState.mapView.zoom);
                }
                
                // Apply selected mine
                if (uiState.selectedMineId) {
                    document.getElementById('mineSelect').value = uiState.selectedMineId;
                }
            },

            // Apply theme
            applyTheme: function(theme) {
                // Remove existing theme classes
                document.body.classList.remove('theme-dark', 'theme-blue', 'theme-green');
                
                // Add new theme class
                document.body.classList.add(`theme-${theme}`);
                
                // Update theme selector
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.classList.remove('active');
                    option.setAttribute('aria-checked', 'false');
                    if (option.getAttribute('data-theme') === theme) {
                        option.classList.add('active');
                        option.setAttribute('aria-checked', 'true');
                    }
                });
            },

            // Apply chart preferences
            applyChartPreferences: function() {
                const prefs = AppState.preferences.display;
                
                // This would be applied when charts are created/updated
                // For now, we'll just note that these preferences are available
                console.log('Chart preferences applied:', {
                    smoothCharts: prefs.smoothCharts,
                    showGridlines: prefs.showGridlines
                });
            },

            // Setup auto-refresh
            setupAutoRefresh: function() {
                // Clear existing interval
                if (AppState.autoRefreshInterval) {
                    clearInterval(AppState.autoRefreshInterval);
                    AppState.autoRefreshInterval = null;
                }
                
                // Setup new interval if auto-refresh is enabled
                if (AppState.preferences.general.autoRefresh) {
                    const interval = AppState.preferences.general.refreshInterval * 60 * 1000; // Convert to milliseconds
                    AppState.autoRefreshInterval = setInterval(() => {
                        UI.showNotification('Auto-refreshing data...', 'info');
                        API.fetchSeismicData();
                    }, interval);
                }
            },

            // Toggle auto-refresh controls visibility
            toggleAutoRefreshControls: function(show) {
                const controls = document.getElementById('autoRefreshControls');
                if (controls) {
                    controls.style.display = show ? 'flex' : 'none';
                }
            },

            // Set checkbox state
            setCheckboxState: function(id, checked) {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = checked;
                }
            },

            // Get current preferences from UI
            getCurrentPreferences: function() {
                return {
                    general: {
                        autoConnect: document.getElementById('autoConnect').checked,
                        rememberFilters: document.getElementById('rememberFilters').checked,
                        autoRefresh: document.getElementById('autoRefresh').checked,
                        refreshInterval: parseInt(document.getElementById('refreshInterval').value) || 5,
                        collapseSidebar: document.getElementById('collapseSidebar').checked,
                        startWithMap: document.getElementById('startWithMap').checked
                    },
                    display: {
                        theme: document.querySelector('.theme-option.active')?.getAttribute('data-theme') || 'dark',
                        smoothCharts: document.getElementById('smoothCharts').checked,
                        showGridlines: document.getElementById('showGridlines').checked,
                        compactMode: document.getElementById('compactMode').checked
                    },
                    data: {
                        cacheData: document.getElementById('cacheData').checked,
                        highPrecision: document.getElementById('highPrecision').checked,
                        saveDataExports: document.getElementById('saveDataExports').checked,
                        retryFailed: document.getElementById('retryFailed').checked,
                        showApiErrors: document.getElementById('showApiErrors').checked
                    },
                    notifications: {
                        notifyErrors: document.getElementById('notifyErrors').checked,
                        notifyHighRisk: document.getElementById('notifyHighRisk').checked,
                        notifyDataUpdates: document.getElementById('notifyDataUpdates').checked,
                        showNotifications: document.getElementById('showNotifications').checked,
                        soundNotifications: document.getElementById('soundNotifications').checked
                    }
                };
            },

            // Save UI state
            saveUIState: function() {
                AppState.preferences.uiState = {
                    seismicFilter: AppState.ui.activeFilters.seismic,
                    seismicSearchTerm: document.getElementById('seismicSearch').value,
                    satelliteTab: document.querySelector('.tab.active')?.getAttribute('aria-controls').replace('-tab', '') || 'insar',
                    mapView: AppState.ui.map ? {
                        lat: AppState.ui.map.getCenter().lat,
                        lng: AppState.ui.map.getCenter().lng,
                        zoom: AppState.ui.map.getZoom()
                    } : { lat: 20, lng: 0, zoom: 2 },
                    selectedMineId: document.getElementById('mineSelect').value
                };
                
                DataPersistence.saveUIState();
            },

            // Reset to default preferences
            resetToDefaults: function() {
                AppState.preferences = JSON.parse(JSON.stringify(CONFIG.DEFAULT_PREFERENCES));
                this.applyPreferences();
                this.savePreferences();
                UI.showNotification('Preferences reset to defaults', 'success');
                AccessibilityManager.announce('Preferences have been reset to default values');
            },

            // Setup event listeners for preferences
            setupEventListeners: function() {
                // Preferences panel toggle
                document.getElementById('preferencesToggle').addEventListener('click', () => {
                    const panel = document.getElementById('preferencesPanel');
                    const isExpanded = panel.classList.toggle('active');
                    document.getElementById('preferencesToggle').setAttribute('aria-expanded', isExpanded);
                    
                    if (isExpanded) {
                        // Focus the first element in the panel when opened
                        setTimeout(() => {
                            const firstFocusable = panel.querySelector('button, input, select');
                            if (firstFocusable) firstFocusable.focus();
                        }, 100);
                    }
                });
                
                document.getElementById('closePreferences').addEventListener('click', () => {
                    document.getElementById('preferencesPanel').classList.remove('active');
                    document.getElementById('preferencesToggle').setAttribute('aria-expanded', 'false');
                    document.getElementById('preferencesToggle').focus();
                });
                
                // Preference tabs
                document.querySelectorAll('.pref-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        AccessibilityManager.activateTab(tab);
                    });
                });
                
                // Theme selection
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const theme = option.getAttribute('data-theme');
                        this.applyTheme(theme);
                    });
                    
                    // Add keyboard support for theme selection
                    option.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            const theme = option.getAttribute('data-theme');
                            this.applyTheme(theme);
                        }
                    });
                });
                
                // Auto-refresh toggle
                document.getElementById('autoRefresh').addEventListener('change', (e) => {
                    this.toggleAutoRefreshControls(e.target.checked);
                });
                
                // Save preferences
                document.getElementById('savePreferences').addEventListener('click', () => {
                    AppState.preferences = this.getCurrentPreferences();
                    if (this.savePreferences()) {
                        this.applyPreferences();
                        UI.showNotification('Preferences saved successfully!', 'success');
                        AccessibilityManager.announce('Preferences saved successfully');
                        document.getElementById('preferencesPanel').classList.remove('active');
                        document.getElementById('preferencesToggle').setAttribute('aria-expanded', 'false');
                    } else {
                        UI.showNotification('Error saving preferences', 'error');
                        AccessibilityManager.announce('Error saving preferences');
                    }
                });
                
                // Reset preferences
                document.getElementById('resetPreferences').addEventListener('click', () => {
                    if (confirm('Are you sure you want to reset all preferences to defaults?')) {
                        this.resetToDefaults();
                    }
                });
                
                // Save UI state on changes
                document.getElementById('seismicSearch').addEventListener('input', () => {
                    this.saveUIState();
                });
                
                document.querySelectorAll('.filter-controls .btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Update aria-pressed state
                        document.querySelectorAll('.filter-controls .btn').forEach(b => {
                            b.setAttribute('aria-pressed', 'false');
                        });
                        btn.setAttribute('aria-pressed', 'true');
                        
                        setTimeout(() => this.saveUIState(), 100);
                    });
                });
                
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        setTimeout(() => this.saveUIState(), 100);
                    });
                });
                
                document.getElementById('mineSelect').addEventListener('change', () => {
                    this.saveUIState();
                });
            }
        };

        // API Functions
        const API = {
            // Generic fetch wrapper with enhanced error handling
            fetchWithRetry: async function(url, options = {}, source = 'unknown') {
                const retryConfig = CONFIG.API.RETRY;
                let lastError = null;
                
                for (let attempt = 1; attempt <= retryConfig.maxRetries; attempt++) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), retryConfig.timeout);
                        
                        const response = await fetch(url, {
                            ...options,
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            const error = new Error(`HTTP ${response.status}: ${response.statusText}`);
                            error.response = response;
                            throw error;
                        }
                        
                        // Reset retry attempts on success
                        AppState.errors.retryAttempts[source] = 0;
                        return response;
                        
                    } catch (error) {
                        lastError = error;
                        
                        // Classify the error
                        const errorType = ErrorHandler.classifyError(error, error.response);
                        
                        // Log the error
                        ErrorHandler.logError(errorType, source, error, {
                            url: url,
                            attempt: attempt,
                            maxRetries: retryConfig.maxRetries
                        });
                        
                        // Don't retry for authentication errors
                        if (errorType === ErrorTypes.AUTH) {
                            break;
                        }
                        
                        // Wait before retrying (except on last attempt)
                        if (attempt < retryConfig.maxRetries) {
                            await new Promise(resolve => 
                                setTimeout(resolve, retryConfig.retryDelay * attempt)
                            );
                        }
                    }
                }
                
                // Update retry attempts
                AppState.errors.retryAttempts[source] = (AppState.errors.retryAttempts[source] || 0) + 1;
                
                throw lastError;
            },

            // Enhanced seismic data fetch
            fetchSeismicData: async function() {
                const button = document.getElementById('getSeismicData');
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<span class="loading"></span> Loading...';
                }
                
                try {
                    const params = new URLSearchParams({
                        ...CONFIG.API.USGS.defaultParams,
                        minmagnitude: 2.5
                    });
                    
                    const url = `${CONFIG.API.USGS.baseUrl}?${params}`;
                    const response = await this.fetchWithRetry(url, {}, 'usgs');
                    
                    const data = await response.json();
                    
                    // Validate response structure
                    if (!data.features || !Array.isArray(data.features)) {
                        throw new Error('Invalid response format from USGS API');
                    }
                    
                    AppState.data.seismic = data.features;
                    
                    // Cache the data
                    DataPersistence.saveData('seismic', AppState.data.seismic);
                    
                    // Update UI
                    UI.displaySeismicData();
                    UI.plotSeismicDataOnMap();
                    UI.updateRiskAssessment();
                    UI.updateDashboardStats();
                    
                    AppState.connections.usgs = true;
                    UI.updateApiStatus();
                    
                    UI.showNotification('Seismic data loaded successfully!', 'success');
                    
                } catch (error) {
                    const errorType = ErrorHandler.classifyError(error);
                    const userMessage = ErrorHandler.getUserFriendlyMessage(errorType, error, 'USGS API');
                    
                    UI.displayErrorState('seismicData', userMessage, error, 'usgs');
                    
                    // Only show notification if enabled
                    if (AppState.preferences.notifications.notifyErrors) {
                        UI.showNotification(`Error loading seismic data: ${userMessage}`, 'error');
                    }
                    
                    AppState.connections.usgs = false;
                    UI.updateApiStatus();
                } finally {
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = 'Get Seismic Data';
                    }
                }
            },

            // Enhanced weather data fetch
            fetchWeatherData: async function() {
                const apiKey = AppState.apiKeys.openWeather;
                if (!apiKey) {
                    UI.showNotification('OpenWeatherMap API key is required', 'error');
                    return;
                }
                
                const button = document.getElementById('getWeatherData');
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<span class="loading"></span> Loading...';
                }
                
                try {
                    const weatherPromises = CONFIG.MINE_LOCATIONS.map(async (location, index) => {
                        const url = `${CONFIG.API.OPEN_WEATHER.baseUrl}${CONFIG.API.OPEN_WEATHER.endpoints.current}?lat=${location.lat}&lon=${location.lon}&appid=${apiKey}&units=metric`;
                        
                        try {
                            const response = await this.fetchWithRetry(url, {}, 'openWeather');
                            return await response.json();
                        } catch (error) {
                            // Log individual location failure but don't fail the entire request
                            ErrorHandler.logError(
                                ErrorHandler.classifyError(error), 
                                'openWeather', 
                                error, 
                                { location: location.name, index }
                            );
                            return null;
                        }
                    });
                    
                    const results = await Promise.all(weatherPromises);
                    AppState.data.weather = results.filter(result => result !== null);
                    
                    if (AppState.data.weather.length === 0) {
                        throw new Error('All weather data requests failed');
                    }
                    
                    UI.displayWeatherData();
                    AppState.connections.openWeather = true;
                    UI.updateApiStatus();
                    
                    UI.showNotification(`Weather data loaded for ${AppState.data.weather.length} locations!`, 'success');
                    
                } catch (error) {
                    const errorType = ErrorHandler.classifyError(error);
                    const userMessage = ErrorHandler.getUserFriendlyMessage(errorType, error, 'OpenWeatherMap API');
                    
                    UI.displayErrorState('weatherData', userMessage, error, 'openWeather');
                    
                    if (AppState.preferences.notifications.notifyErrors) {
                        UI.showNotification(`Error loading weather data: ${userMessage}`, 'error');
                    }
                    
                    AppState.connections.openWeather = false;
                    UI.updateApiStatus();
                } finally {
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = 'Get Weather Data';
                    }
                }
            },

            // Fetch geological survey data
            fetchGeoData: async function() {
                const button = document.getElementById('getGeoData');
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<span class="loading"></span> Loading...';
                }
                
                try {
                    // Simulate API call with timeout
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Mock data for demonstration
                    const mockGeoData = [
                        {
                            region: "Andean Copper Belt",
                            rockType: "Porphyry Copper",
                            hazardLevel: "Medium",
                            lastSurvey: "2023-11-15",
                            stability: "Moderate"
                        },
                        {
                            region: "Western Australian Craton",
                            rockType: "Iron Formation",
                            hazardLevel: "Low",
                            lastSurvey: "2023-10-22",
                            stability: "High"
                        },
                        {
                            region: "African Copper Belt",
                            rockType: "Sedimentary Copper",
                            hazardLevel: "High",
                            lastSurvey: "2023-12-05",
                            stability: "Low"
                        },
                        {
                            region: "Canadian Shield",
                            rockType: "Precambrian Greenstone",
                            hazardLevel: "Medium",
                            lastSurvey: "2023-09-30",
                            stability: "Moderate"
                        }
                    ];
                    
                    AppState.data.geo = mockGeoData;
                    UI.displayGeoData();
                    UI.updateDashboardStats();
                    
                    AppState.connections.nationalGeo = true;
                    UI.updateApiStatus();
                    
                    UI.showNotification('Geological data loaded successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error fetching geological data:', error);
                    UI.displayErrorState('geoData', 'Error loading geological data', error, 'nationalGeo');
                    
                    if (AppState.preferences.notifications.notifyErrors) {
                        UI.showNotification('Error loading geological data: ' + error.message, 'error');
                    }
                } finally {
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = 'Get Geological Data';
                    }
                }
            },
            
            // Fetch satellite and InSAR data
            fetchSatelliteData: async function() {
                const button = document.getElementById('getSatelliteData');
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<span class="loading"></span> Loading...';
                }
                
                try {
                    // Simulate API call with timeout
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Mock data for demonstration
                    const mockInSARData = [
                        {
                            location: "Chuquicamata Mine, Chile",
                            displacement: "12mm",
                            period: "2023-10-01 to 2023-11-30",
                            trend: "Subsidence"
                        },
                        {
                            location: "Grasberg Mine, Indonesia",
                            displacement: "8mm",
                            period: "2023-10-15 to 2023-11-30",
                            trend: "Stable"
                        },
                        {
                            location: "Super Pit Mine, Australia",
                            displacement: "18mm",
                            period: "2023-09-01 to 2023-11-30",
                            trend: "Uplift"
                        }
                    ];
                    
                    AppState.data.satellite = {
                        insar: mockInSARData,
                        imagery: "https://via.placeholder.com/600x300/121821/12d6df?text=Satellite+Imagery+Placeholder"
                    };
                    
                    UI.displaySatelliteData();
                    
                    AppState.connections.satellite = true;
                    UI.updateApiStatus();
                    
                    UI.showNotification('Satellite data loaded successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error fetching satellite data:', error);
                    UI.displayErrorState('satelliteData', 'Error loading satellite data', error, 'satellite');
                    
                    if (AppState.preferences.notifications.notifyErrors) {
                        UI.showNotification('Error loading satellite data: ' + error.message, 'error');
                    }
                } finally {
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = 'Get Satellite Data';
                    }
                }
            },
            
            // Fetch mine sensor data
            fetchSensorData: async function() {
                const button = document.getElementById('getSensorData');
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<span class="loading"></span> Loading...';
                }
                
                try {
                    // Simulate API call with timeout
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Mock data for demonstration
                    const mockSensorData = {
                        mine: "Chuquicamata Copper Mine",
                        sensors: [
                            { id: "S-001", type: "Vibration", value: "0.12g", status: "Normal" },
                            { id: "S-002", type: "Groundwater", value: "42.5m", status: "Elevated" },
                            { id: "S-003", type: "Slope", value: "2.7°", status: "Normal" },
                            { id: "S-004", type: "Air Quality", value: "32ppm", status: "Warning" },
                            { id: "S-005", type: "Structural", value: "0.8mm", status: "Normal" },
                            { id: "S-006", type: "Seismic", value: "1.2ML", status: "Normal" }
                        ]
                    };
                    
                    AppState.data.sensor = mockSensorData;
                    UI.displaySensorData();
                    
                    AppState.connections.mineSensors = true;
                    UI.updateApiStatus();
                    
                    UI.showNotification('Sensor data loaded successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error fetching sensor data:', error);
                    UI.displayErrorState('sensorData', 'Error loading sensor data', error, 'mineSensors');
                    
                    if (AppState.preferences.notifications.notifyErrors) {
                        UI.showNotification('Error loading sensor data: ' + error.message, 'error');
                    }
                } finally {
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = 'Get Sensor Data';
                    }
                }
            },
            
            // Fetch rockfall data
            fetchRockfallData: async function() {
                const button = document.getElementById('getRockfallData');
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<span class="loading"></span> Loading...';
                }
                
                try {
                    // For demo purposes, we'll use mock data
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Mock rockfall data
                    const mockRockfallData = [
                        {
                            rainfall: 15.2,
                            temperature: 25.6,
                            slope_angle: 45.3,
                            seismic_magnitude: 2.8,
                            crack_width: 12.5,
                            risk_score: 65,
                            risk_level: "medium",
                            recorded_at: "2023-12-01T10:30:00Z"
                        },
                        {
                            rainfall: 8.7,
                            temperature: 28.1,
                            slope_angle: 42.8,
                            seismic_magnitude: 1.5,
                            crack_width: 8.3,
                            risk_score: 42,
                            risk_level: "medium",
                            recorded_at: "2023-11-30T14:45:00Z"
                        },
                        {
                            rainfall: 22.4,
                            temperature: 22.3,
                            slope_angle: 47.1,
                            seismic_magnitude: 3.2,
                            crack_width: 15.7,
                            risk_score: 78,
                            risk_level: "high",
                            recorded_at: "2023-11-29T08:15:00Z"
                        }
                    ];
                    
                    AppState.data.rockfall = mockRockfallData;
                    AppState.connections.rockfall = true;
                    
                    // Cache the data
                    DataPersistence.saveData('rockfall', AppState.data.rockfall);
                    
                    UI.updateApiStatus();
                    UI.updateDashboardStats();
                    UI.displayRockfallData();
                    UI.updateRockfallChart();
                    
                    UI.showNotification('Rockfall data loaded successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error fetching rockfall data:', error);
                    UI.displayErrorState('rockfallData', 'Error loading rockfall data', error, 'rockfall');
                    
                    if (AppState.preferences.notifications.notifyErrors) {
                        UI.showNotification('Error loading rockfall data: ' + error.message, 'error');
                    }
                } finally {
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = 'Get Rockfall Data';
                    }
                }
            },

            // Retry failed APIs
            retryFailedApis: async function() {
                const failedApis = Object.entries(AppState.connections)
                    .filter(([_, connected]) => !connected)
                    .map(([api]) => api);
                
                if (failedApis.length === 0) {
                    UI.showNotification('No failed connections to retry', 'info');
                    return;
                }
                
                UI.showNotification(`Retrying ${failedApis.length} failed connections...`, 'info');
                
                for (const api of failedApis) {
                    try {
                        switch (api) {
                            case 'usgs':
                                await this.fetchSeismicData();
                                break;
                            case 'openWeather':
                                await this.fetchWeatherData();
                                break;
                            case 'nationalGeo':
                                await this.fetchGeoData();
                                break;
                            case 'satellite':
                                await this.fetchSatelliteData();
                                break;
                            case 'mineSensors':
                                await this.fetchSensorData();
                                break;
                            case 'rockfall':
                                await this.fetchRockfallData();
                                break;
                        }
                    } catch (error) {
                        console.error(`Failed to retry ${api}:`, error);
                    }
                }
            }
        };

        // UI Components
        const UI = {
            // DOM Elements
            elements: {
                // API Configuration
                usgsApiKey: document.getElementById('usgsApiKey'),
                weatherApiKey: document.getElementById('weatherApiKey'),
                nationalGeoApiKey: document.getElementById('nationalGeoApiKey'),
                satelliteApiKey: document.getElementById('satelliteApiKey'),
                saveConfigBtn: document.getElementById('saveConfig'),
                
                // API Controls
                connectAllBtn: document.getElementById('connectAll'),
                getSeismicDataBtn: document.getElementById('getSeismicData'),
                getWeatherDataBtn: document.getElementById('getWeatherData'),
                getGeoDataBtn: document.getElementById('getGeoData'),
                getSatelliteDataBtn: document.getElementById('getSatelliteData'),
                getSensorDataBtn: document.getElementById('getSensorData'),
                getRockfallDataBtn: document.getElementById('getRockfallData'),
                uploadRockfallDataBtn: document.getElementById('uploadRockfallData'),
                retryFailedBtn: document.getElementById('retryFailedBtn'),
                clearErrorsBtn: document.getElementById('clearErrors'),
                
                // Status and Data Containers
                apiStatus: document.getElementById('apiStatus'),
                seismicData: document.getElementById('seismicData'),
                weatherData: document.getElementById('weatherData'),
                geoData: document.getElementById('geoData'),
                satelliteData: document.getElementById('satelliteData'),
                sensorData: document.getElementById('sensorData'),
                rockfallData: document.getElementById('rockfallData'),
                dashboardStats: document.getElementById('dashboardStats'),
                
                // Rockfall Upload
                mineSelect: document.getElementById('mineSelect'),
                csvFile: document.getElementById('csvFile'),
                browseBtn: document.getElementById('browseBtn'),
                fileName: document.getElementById('fileName'),
                uploadCsvBtn: document.getElementById('uploadCsvBtn'),
                previewCsvBtn: document.getElementById('previewCsvBtn'),
                previewSection: document.getElementById('previewSection'),
                previewTable: document.getElementById('previewTable'),
                confirmUploadBtn: document.getElementById('confirmUploadBtn'),
                cancelPreviewBtn: document.getElementById('cancelPreviewBtn'),
                uploadProgress: document.getElementById('uploadProgress'),
                progressBar: document.getElementById('progressBar'),
                progressPercent: document.getElementById('progressPercent'),
                uploadStatus: document.getElementById('uploadStatus'),
                
                // Search and Filter
                seismicSearch: document.getElementById('seismicSearch'),
                
                // Notification
                notification: document.getElementById('notification'),
                
                // Error Log
                apiErrorLog: document.getElementById('apiErrorLog'),
                errorLogContent: document.getElementById('errorLogContent'),
                
                // Preferences
                preferencesPanel: document.getElementById('preferencesPanel'),
                preferencesToggle: document.getElementById('preferencesToggle')
            },
            
            // Initialize UI components
            init: function() {
                this.initTabs();
                this.loadApiConfig();
                this.updateApiStatus();
                this.loadMines();
                this.setupEventListeners();
                this.initMap();
                this.initCharts();
                
                // Initialize preferences manager
                PreferencesManager.init();
                
                // Initialize accessibility manager
                AccessibilityManager.init();
                
                // Load cached data if available
                this.loadCachedData();
            },
            
            // Initialize the map
            initMap: function() {
                if (AppState.ui.map) return;
                
                // Use saved map view or default
                const mapView = AppState.preferences.uiState.mapView || { lat: 20, lng: 0, zoom: 2 };
                
                AppState.ui.map = L.map('map').setView([mapView.lat, mapView.lng], mapView.zoom);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(AppState.ui.map);
                
                // Add accessibility attributes to map
                const mapElement = document.getElementById('map');
                mapElement.setAttribute('role', 'application');
                mapElement.setAttribute('aria-label', 'Interactive map showing seismic activity locations');
                
                // Save map view on move
                AppState.ui.map.on('moveend', () => {
                    PreferencesManager.saveUIState();
                });
            },
            
            // Initialize charts
            initCharts: function() {
                this.initRiskChart();
                this.initRockfallChart();
            },
            
            // Initialize risk assessment chart
            initRiskChart: function() {
                const ctx = document.getElementById('riskChart').getContext('2d');
                
                if (AppState.ui.riskChart) {
                    AppState.ui.riskChart.destroy();
                }
                
                AppState.ui.riskChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                        datasets: [{
                            label: 'Mines by Risk Level',
                            data: [0, 0, 0],
                            backgroundColor: [
                                'rgba(30, 194, 139, 0.7)',
                                'rgba(255, 176, 32, 0.7)',
                                'rgba(255, 92, 92, 0.7)'
                            ],
                            borderColor: [
                                'rgba(30, 194, 139, 1)',
                                'rgba(255, 176, 32, 1)',
                                'rgba(255, 92, 92, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Mines'
                                }
                            }
                        },
                        // Accessibility options
                        animation: {
                            duration: AppState.preferences.display.smoothCharts ? 1000 : 0
                        }
                    }
                });
            },
            
            // Initialize rockfall chart
            initRockfallChart: function() {
                const ctx = document.getElementById('rockfallChart').getContext('2d');
                
                if (AppState.ui.rockfallChart) {
                    AppState.ui.rockfallChart.destroy();
                }
                
                AppState.ui.rockfallChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Risk Score',
                                data: [],
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                yAxisID: 'y',
                                tension: 0.1
                            },
                            {
                                label: 'Rainfall (mm)',
                                data: [],
                                borderColor: 'rgb(54, 162, 235)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                yAxisID: 'y1',
                                tension: 0.1
                            },
                            {
                                label: 'Crack Width (mm)',
                                data: [],
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                yAxisID: 'y1',
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Risk Score'
                                },
                                min: 0,
                                max: 100
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Rainfall / Crack Width'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                            }
                        },
                        // Accessibility options
                        animation: {
                            duration: AppState.preferences.display.smoothCharts ? 1000 : 0
                        }
                    }
                });
            },
            
            // Initialize tab functionality
            initTabs: function() {
                const tabs = document.querySelectorAll('.tab');
                
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        AccessibilityManager.activateTab(tab);
                    });
                });
            },
            
            // Setup event listeners
            setupEventListeners: function() {
                // API Configuration
                this.elements.saveConfigBtn.addEventListener('click', () => this.saveApiConfig());
                
                // API Controls
                this.elements.connectAllBtn.addEventListener('click', () => this.connectToAllApis());
                this.elements.getSeismicDataBtn.addEventListener('click', () => API.fetchSeismicData());
                this.elements.getWeatherDataBtn.addEventListener('click', () => API.fetchWeatherData());
                this.elements.getGeoDataBtn.addEventListener('click', () => API.fetchGeoData());
                this.elements.getSatelliteDataBtn.addEventListener('click', () => API.fetchSatelliteData());
                this.elements.getSensorDataBtn.addEventListener('click', () => API.fetchSensorData());
                this.elements.getRockfallDataBtn.addEventListener('click', () => API.fetchRockfallData());
                this.elements.uploadRockfallDataBtn.addEventListener('click', () => this.showNotification('Upload functionality would be implemented here', 'info'));
                
                // Enhanced error handling buttons
                this.elements.retryFailedBtn.addEventListener('click', () => API.retryFailedApis());
                this.elements.clearErrorsBtn.addEventListener('click', () => {
                    ErrorHandler.clearErrors();
                    this.showNotification('Error log cleared', 'success');
                });
                
                // Rockfall Upload
                this.elements.browseBtn.addEventListener('click', () => this.elements.csvFile.click());
                this.elements.csvFile.addEventListener('change', (e) => this.handleFileSelect(e));
                this.elements.uploadCsvBtn.addEventListener('click', () => this.uploadCSV());
                this.elements.previewCsvBtn.addEventListener('click', () => this.previewCSV());
                this.elements.confirmUploadBtn.addEventListener('click', () => this.confirmUpload());
                this.elements.cancelPreviewBtn.addEventListener('click', () => this.cancelPreview());
                
                // Mine selection
                this.elements.mineSelect.addEventListener('change', () => this.updateUploadButtonState());
                
                // Search and Filter
                this.elements.seismicSearch.addEventListener('input', (e) => this.filterSeismicData(e.target.value));
                
                // Filter buttons
                document.querySelectorAll('.filter-controls .btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-controls .btn').forEach(b => {
                            b.classList.remove('active');
                            b.setAttribute('aria-pressed', 'false');
                        });
                        e.target.classList.add('active');
                        e.target.setAttribute('aria-pressed', 'true');
                        AppState.ui.activeFilters.seismic = e.target.getAttribute('data-filter');
                        this.filterSeismicData(this.elements.seismicSearch.value);
                    });
                });
                
                // Network status monitoring
                window.addEventListener('online', () => {
                    this.showNotification('Network connection restored', 'success');
                    // Auto-retry failed connections when coming back online
                    setTimeout(() => API.retryFailedApis(), 1000);
                });

                window.addEventListener('offline', () => {
                    this.showNotification('Network connection lost', 'error');
                });
            },
            
            // Connect to all APIs
            connectToAllApis: async function() {
                const button = this.elements.connectAllBtn;
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<span class="loading"></span> Connecting...';
                }
                
                try {
                    // Use Promise.all to run all API calls in parallel
                    await Promise.all([
                        API.fetchSeismicData(),
                        AppState.apiKeys.openWeather ? API.fetchWeatherData() : Promise.resolve(),
                        API.fetchGeoData(),
                        API.fetchSatelliteData(),
                        API.fetchSensorData(),
                        API.fetchRockfallData()
                    ]);
                    
                    this.showNotification('All APIs connected successfully!', 'success');
                } catch (error) {
                    this.showNotification('Error connecting to some APIs: ' + error.message, 'error');
                } finally {
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = 'Connect to All APIs';
                    }
                }
            },
            
            // Enhanced API status display with error counts
            updateApiStatus: function() {
                const statusHTML = `
                    <div class="connection-status">
                        <span class="status-indicator ${AppState.connections.usgs ? 'status-connected' : 'status-disconnected'}" aria-label="${AppState.connections.usgs ? 'Connected' : 'Disconnected'}"></span>
                        <div>
                            <div>USGS API: ${AppState.connections.usgs ? 'Connected' : 'Disconnected'}</div>
                            ${AppState.errors.counts.usgs > 0 ? 
                                `<div class="status-detail">Errors: ${AppState.errors.counts.usgs} | Retries: ${AppState.errors.retryAttempts.usgs || 0}</div>` : ''}
                        </div>
                    </div>
                    <div class="connection-status">
                        <span class="status-indicator ${AppState.connections.openWeather ? 'status-connected' : 'status-disconnected'}" aria-label="${AppState.connections.openWeather ? 'Connected' : 'Disconnected'}"></span>
                        <div>
                            <div>OpenWeatherMap API: ${AppState.connections.openWeather ? 'Connected' : 'Disconnected'}</div>
                            ${AppState.errors.counts.openWeather > 0 ? 
                                `<div class="status-detail">Errors: ${AppState.errors.counts.openWeather} | Retries: ${AppState.errors.retryAttempts.openWeather || 0}</div>` : ''}
                        </div>
                    </div>
                    <div class="connection-status">
                        <span class="status-indicator ${AppState.connections.nationalGeo ? 'status-connected' : 'status-disconnected'}" aria-label="${AppState.connections.nationalGeo ? 'Connected' : 'Disconnected'}"></span>
                        <div>
                            <div>National Geological Survey API: ${AppState.connections.nationalGeo ? 'Connected' : 'Disconnected'}</div>
                            ${AppState.errors.counts.nationalGeo > 0 ? 
                                `<div class="status-detail">Errors: ${AppState.errors.counts.nationalGeo} | Retries: ${AppState.errors.retryAttempts.nationalGeo || 0}</div>` : ''}
                        </div>
                    </div>
                    <div class="connection-status">
                        <span class="status-indicator ${AppState.connections.satellite ? 'status-connected' : 'status-disconnected'}" aria-label="${AppState.connections.satellite ? 'Connected' : 'Disconnected'}"></span>
                        <div>
                            <div>Satellite Data API: ${AppState.connections.satellite ? 'Connected' : 'Disconnected'}</div>
                            ${AppState.errors.counts.satellite > 0 ? 
                                `<div class="status-detail">Errors: ${AppState.errors.counts.satellite} | Retries: ${AppState.errors.retryAttempts.satellite || 0}</div>` : ''}
                        </div>
                    </div>
                    <div class="connection-status">
                        <span class="status-indicator ${AppState.connections.mineSensors ? 'status-connected' : 'status-disconnected'}" aria-label="${AppState.connections.mineSensors ? 'Connected' : 'Disconnected'}"></span>
                        <div>
                            <div>Mine Sensor Network: ${AppState.connections.mineSensors ? 'Connected' : 'Disconnected'}</div>
                            ${AppState.errors.counts.mineSensors > 0 ? 
                                `<div class="status-detail">Errors: ${AppState.errors.counts.mineSensors} | Retries: ${AppState.errors.retryAttempts.mineSensors || 0}</div>` : ''}
                        </div>
                    </div>
                    <div class="connection-status">
                        <span class="status-indicator ${AppState.connections.rockfall ? 'status-connected' : 'status-disconnected'}" aria-label="${AppState.connections.rockfall ? 'Loaded' : 'Not loaded'}"></span>
                        <div>
                            <div>Rockfall Data: ${AppState.connections.rockfall ? 'Loaded' : 'Not Loaded'}</div>
                            ${AppState.errors.counts.rockfall > 0 ? 
                                `<div class="status-detail">Errors: ${AppState.errors.counts.rockfall} | Retries: ${AppState.errors.retryAttempts.rockfall || 0}</div>` : ''}
                        </div>
                    </div>
                `;
                
                this.elements.apiStatus.innerHTML = statusHTML;
                
                // Show/hide retry button based on failed connections
                const hasFailedConnections = Object.values(AppState.connections).some(connected => !connected);
                this.elements.retryFailedBtn.style.display = hasFailedConnections ? 'inline-block' : 'none';
                
                // Update error display
                ErrorHandler.updateErrorDisplay();
            },
            
            // Update dashboard statistics
            updateDashboardStats: function() {
                const statsHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Seismic Events</div>
                        <div class="stat-value">${AppState.data.seismic.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Monitored Mines</div>
                        <div class="stat-value">${CONFIG.MINE_LOCATIONS.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Rockfall Records</div>
                        <div class="stat-value">${AppState.data.rockfall.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">High Risk Areas</div>
                        <div class="stat-value" style="color: var(--risk);">${this.calculateHighRiskAreas()}</div>
                    </div>
                `;
                
                this.elements.dashboardStats.innerHTML = statsHTML;
            },
            
            // Calculate high risk areas
            calculateHighRiskAreas: function() {
                let highRiskCount = 0;
                
                // Count high risk seismic events
                highRiskCount += AppState.data.seismic.filter(event => 
                    event.properties.mag >= CONFIG.RISK_THRESHOLDS.MEDIUM
                ).length;
                
                // Count high risk geological areas
                highRiskCount += AppState.data.geo.filter(area => 
                    area.hazardLevel === "High"
                ).length;
                
                return highRiskCount;
            },
            
            // Show notification
            showNotification: function(message, type = 'info') {
                // Check if notifications are enabled
                if (!AppState.preferences.notifications.showNotifications) return;
                
                const notification = this.elements.notification;
                notification.textContent = message;
                notification.className = `notification ${type} show`;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            },
            
            // Display error state for data containers
            displayErrorState: function(containerId, message, error, source) {
                const container = document.getElementById(containerId);
                const errorId = `error-${source}-${Date.now()}`;
                
                container.innerHTML = `
                    <div class="error-state">
                        <div>❌ ${message}</div>
                        <button onclick="UI.toggleErrorDetails('${errorId}')" class="retry-btn">
                            Show Details
                        </button>
                        <button onclick="API.retryFailedApis()" class="retry-btn">
                            Retry All Failed
                        </button>
                        <div id="${errorId}" class="error-details">
                            <strong>Error Details:</strong><br>
                            ${error.message}<br>
                            ${error.stack ? `<small>${error.stack}</small>` : ''}
                        </div>
                    </div>
                `;
            },

            // Toggle error details visibility
            toggleErrorDetails: function(errorId) {
                const details = document.getElementById(errorId);
                const isShowing = details.classList.toggle('show');
                details.setAttribute('aria-expanded', isShowing);
            },
            
            // Handle file selection for CSV upload
            handleFileSelect: function(event) {
                const file = event.target.files[0];
                if (file) {
                    this.elements.fileName.textContent = file.name;
                    this.elements.fileName.style.color = 'var(--text)';
                    this.updateUploadButtonState();
                }
            },
            
            // Update upload button state based on selection
            updateUploadButtonState: function() {
                const mineId = this.elements.mineSelect.value;
                const fileSelected = this.elements.csvFile.files.length > 0;
                
                if (mineId && fileSelected) {
                    this.elements.uploadCsvBtn.disabled = false;
                    this.elements.previewCsvBtn.disabled = false;
                } else {
                    this.elements.uploadCsvBtn.disabled = true;
                    this.elements.previewCsvBtn.disabled = true;
                }
            },
            
            // Save API configuration
            saveApiConfig: function() {
                AppState.apiKeys.usgs = this.elements.usgsApiKey.value;
                AppState.apiKeys.openWeather = this.elements.weatherApiKey.value;
                AppState.apiKeys.nationalGeo = this.elements.nationalGeoApiKey.value;
                AppState.apiKeys.satellite = this.elements.satelliteApiKey.value;
                
                DataPersistence.saveApiKeys();
                this.showNotification('API configuration saved successfully!', 'success');
            },
            
            // Load saved API configuration
            loadApiConfig: function() {
                if (DataPersistence.loadApiKeys()) {
                    this.elements.usgsApiKey.value = AppState.apiKeys.usgs;
                    this.elements.weatherApiKey.value = AppState.apiKeys.openWeather;
                    this.elements.nationalGeoApiKey.value = AppState.apiKeys.nationalGeo;
                    this.elements.satelliteApiKey.value = AppState.apiKeys.satellite;
                }
            },
            
            // Load cached data
            loadCachedData: function() {
                // Try to load cached seismic data
                const cachedSeismic = DataPersistence.loadData('seismic', 10 * 60 * 1000); // 10 minutes
                if (cachedSeismic) {
                    AppState.data.seismic = cachedSeismic;
                    this.displaySeismicData();
                    this.plotSeismicDataOnMap();
                    this.updateRiskAssessment();
                    this.updateDashboardStats();
                    AppState.connections.usgs = true;
                    this.updateApiStatus();
                    this.showNotification('Loaded cached seismic data', 'info');
                }
                
                // Try to load cached rockfall data
                const cachedRockfall = DataPersistence.loadData('rockfall', 15 * 60 * 1000); // 15 minutes
                if (cachedRockfall) {
                    AppState.data.rockfall = cachedRockfall;
                    AppState.connections.rockfall = true;
                    this.updateApiStatus();
                    this.updateDashboardStats();
                    this.displayRockfallData();
                    this.updateRockfallChart();
                    this.showNotification('Loaded cached rockfall data', 'info');
                }
            },
            
            // Load mines for selection
            loadMines: function() {
                // Simulate API call to load mines
                setTimeout(() => {
                    const mockMines = [
                        { id: 1, name: 'Chuquicamata Copper Mine', company: 'Codelco' },
                        { id: 2, name: 'Escondida Copper Mine', company: 'BHP' },
                        { id: 3, name: 'Grasberg Mine', company: 'Freeport-McMoRan' },
                        { id: 4, name: 'Super Pit Gold Mine', company: 'Northern Star' }
                    ];
                    
                    this.elements.mineSelect.innerHTML = '<option value="">Select a mine</option>' +
                        mockMines.map(mine => 
                            `<option value="${mine.id}">${mine.name} (${mine.company})</option>`
                        ).join('');
                }, 500);
            },
            
            // Filter seismic data based on search and filter criteria
            filterSeismicData: function(searchTerm) {
                let filteredData = AppState.data.seismic;
                
                // Apply search filter
                if (searchTerm) {
                    filteredData = filteredData.filter(event => 
                        event.properties.place.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }
                
                // Apply risk filter
                if (AppState.ui.activeFilters.seismic !== 'all') {
                    filteredData = filteredData.filter(event => {
                        const magnitude = event.properties.mag;
                        
                        if (AppState.ui.activeFilters.seismic === 'low') {
                            return magnitude < CONFIG.RISK_THRESHOLDS.LOW;
                        } else if (AppState.ui.activeFilters.seismic === 'medium') {
                            return magnitude >= CONFIG.RISK_THRESHOLDS.LOW && magnitude < CONFIG.RISK_THRESHOLDS.MEDIUM;
                        } else if (AppState.ui.activeFilters.seismic === 'high') {
                            return magnitude >= CONFIG.RISK_THRESHOLDS.MEDIUM;
                        }
                        
                        return true;
                    });
                }
                
                this.displaySeismicData(filteredData);
            },
            
            // Display seismic data in the UI
            displaySeismicData: function(data = null) {
                const seismicData = data || AppState.data.seismic;
                const container = this.elements.seismicData;
                
                if (!seismicData.length) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span aria-hidden="true">🌋</span>
                            <p>No seismic data available matching your criteria.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                seismicData.slice(0, 10).forEach(event => {
                    const magnitude = event.properties.mag;
                    const place = event.properties.place;
                    const time = new Date(event.properties.time).toLocaleString();
                    const depth = event.geometry.coordinates[2];
                    
                    let riskLevel = 'risk-low';
                    if (magnitude >= CONFIG.RISK_THRESHOLDS.MEDIUM) riskLevel = 'risk-high';
                    else if (magnitude >= CONFIG.RISK_THRESHOLDS.LOW) riskLevel = 'risk-medium';
                    
                    html += `
                        <div class="data-item">
                            <div><strong>${place}</strong></div>
                            <div>Magnitude: <span class="${riskLevel}">${magnitude}</span></div>
                            <div>Depth: ${depth} km</div>
                            <div>Time: ${time}</div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            // Display weather data in the UI
            displayWeatherData: function() {
                const container = this.elements.weatherData;
                
                if (!AppState.data.weather.length) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span aria-hidden="true">🌤️</span>
                            <p>No weather data available.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                AppState.data.weather.forEach((weather, index) => {
                    const mineName = CONFIG.MINE_LOCATIONS[index].name;
                    const temp = weather.main.temp;
                    const humidity = weather.main.humidity;
                    const conditions = weather.weather[0].description;
                    const windSpeed = weather.wind.speed;
                    
                    html += `
                        <div class="data-item">
                            <div><strong>${mineName}</strong></div>
                            <div>Temperature: ${temp}°C</div>
                            <div>Humidity: ${humidity}%</div>
                            <div>Conditions: ${conditions}</div>
                            <div>Wind Speed: ${windSpeed} m/s</div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            // Display geological data in the UI
            displayGeoData: function() {
                const container = this.elements.geoData;
                
                if (!AppState.data.geo.length) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span aria-hidden="true">⛰️</span>
                            <p>No geological data available.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                AppState.data.geo.forEach(geo => {
                    let riskClass = 'risk-low';
                    if (geo.hazardLevel === "High") riskClass = 'risk-high';
                    else if (geo.hazardLevel === "Medium") riskClass = 'risk-medium';
                    
                    html += `
                        <div class="data-item">
                            <div><strong>${geo.region}</strong></div>
                            <div>Rock Type: ${geo.rockType}</div>
                            <div>Hazard Level: <span class="${riskClass}">${geo.hazardLevel}</span></div>
                            <div>Stability: ${geo.stability}</div>
                            <div>Last Survey: ${geo.lastSurvey}</div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            // Display satellite data in the UI
            displaySatelliteData: function() {
                if (!AppState.data.satellite.insar) {
                    document.querySelector('#insar-tab').innerHTML = `
                        <div class="empty-state">
                            <span aria-hidden="true">🛰️</span>
                            <p>No InSAR data available.</p>
                        </div>
                    `;
                    document.querySelector('#satellite-tab').innerHTML = `
                        <div class="empty-state">
                            <span aria-hidden="true">📡</span>
                            <p>No satellite imagery available.</p>
                        </div>
                    `;
                    return;
                }
                
                // Display InSAR data
                let insarHtml = '';
                AppState.data.satellite.insar.forEach(insar => {
                    insarHtml += `
                        <div class="data-item">
                            <div><strong>${insar.location}</strong></div>
                            <div>Displacement: ${insar.displacement}</div>
                            <div>Period: ${insar.period}</div>
                            <div>Trend: ${insar.trend}</div>
                        </div>
                    `;
                });
                document.querySelector('#insar-tab').innerHTML = insarHtml;
                
                // Display satellite imagery (placeholder)
                document.querySelector('#satellite-tab').innerHTML = `
                    <img src="https://via.placeholder.com/600x300/121821/12d6df?text=Satellite+Imagery+Placeholder" class="insar-image" alt="Satellite imagery showing mine area and surrounding terrain" loading="lazy">
                    <p>Satellite imagery showing mine area and surrounding terrain.</p>
                    <p>Date: 2023-12-01 | Resolution: 30cm/pixel</p>
                `;
            },
            
            // Display sensor data in the UI
            displaySensorData: function() {
                const container = this.elements.sensorData;
                
                if (!AppState.data.sensor.sensors) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span aria-hidden="true">📊</span>
                            <p>No sensor data available.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `<h3>${AppState.data.sensor.mine}</h3>`;
                html += '<div class="sensor-grid">';
                
                AppState.data.sensor.sensors.forEach(sensor => {
                    let statusClass = 'risk-low';
                    if (sensor.status === "Warning") statusClass = 'risk-medium';
                    else if (sensor.status === "Danger") statusClass = 'risk-high';
                    
                    html += `
                        <div class="sensor-card">
                            <div><strong>${sensor.type} Sensor</strong> (${sensor.id})</div>
                            <div class="sensor-value">${sensor.value}</div>
                            <div>Status: <span class="${statusClass}">${sensor.status}</span></div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            },
            
            // Display rockfall data in the UI
            displayRockfallData: function() {
                const container = this.elements.rockfallData;
                
                if (!AppState.data.rockfall.length) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span aria-hidden="true">🪨</span>
                            <p>No rockfall data available.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                AppState.data.rockfall.forEach(data => {
                    let riskClass = 'risk-low';
                    if (data.risk_level === "high") riskClass = 'risk-high';
                    else if (data.risk_level === "medium") riskClass = 'risk-medium';
                    
                    html += `
                        <div class="data-item">
                            <div><strong>Recorded: ${new Date(data.recorded_at).toLocaleString()}</strong></div>
                            <div>Rainfall: ${data.rainfall} mm</div>
                            <div>Temperature: ${data.temperature}°C</div>
                            <div>Slope Angle: ${data.slope_angle}°</div>
                            <div>Seismic Magnitude: ${data.seismic_magnitude}</div>
                            <div>Crack Width: ${data.crack_width} mm</div>
                            <div>Risk Score: <span class="${riskClass}">${data.risk_score} (${data.risk_level})</span></div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            // Plot seismic data on the map
            plotSeismicDataOnMap: function() {
                if (!AppState.ui.map) return; // Map might not be initialized yet
                
                // Clear existing markers
                AppState.ui.map.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                        AppState.ui.map.removeLayer(layer);
                    }
                });
                
                // Add new markers
                AppState.data.seismic.forEach(event => {
                    const [lng, lat, depth] = event.geometry.coordinates;
                    const magnitude = event.properties.mag;
                    const place = event.properties.place;
                    
                    let color = '#1ec28b'; // Green for low risk
                    if (magnitude >= CONFIG.RISK_THRESHOLDS.MEDIUM) color = '#ff5c5c'; // Red for high risk
                    else if (magnitude >= CONFIG.RISK_THRESHOLDS.LOW) color = '#ffb020'; // Orange for medium risk
                    
                    const marker = L.circleMarker([lat, lng], {
                        radius: magnitude * 2,
                        fillColor: color,
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(AppState.ui.map);
                    
                    marker.bindPopup(`
                        <strong>${place}</strong><br>
                        Magnitude: ${magnitude}<br>
                        Depth: ${depth} km
                    `);
                });
                
                // Fit map to show all markers
                if (AppState.data.seismic.length > 0) {
                    const group = new L.featureGroup(
                        AppState.data.seismic.map(event => {
                            const [lng, lat] = event.geometry.coordinates;
                            return L.marker([lat, lng]);
                        })
                    );
                    AppState.ui.map.fitBounds(group.getBounds().pad(0.1));
                }
            },
            
            // Update risk assessment chart
            updateRiskAssessment: function() {
                if (!AppState.ui.riskChart) return; // Chart might not be initialized yet
                
                // Calculate risk distribution based on available data
                const lowRisk = 10 + Math.floor(Math.random() * 5);
                const mediumRisk = 5 + Math.floor(Math.random() * 3);
                const highRisk = 2 + Math.floor(Math.random() * 3);
                
                AppState.ui.riskChart.data.datasets[0].data = [lowRisk, mediumRisk, highRisk];
                AppState.ui.riskChart.update();
            },
            
            // Update rockfall chart
            updateRockfallChart: function() {
                if (!AppState.ui.rockfallChart) return; // Chart might not be initialized yet
                
                const labels = AppState.data.rockfall.map(d => new Date(d.recorded_at).toLocaleDateString());
                const riskScores = AppState.data.rockfall.map(d => d.risk_score);
                const rainfall = AppState.data.rockfall.map(d => d.rainfall);
                const crackWidth = AppState.data.rockfall.map(d => d.crack_width);
                
                AppState.ui.rockfallChart.data.labels = labels;
                AppState.ui.rockfallChart.data.datasets[0].data = riskScores;
                AppState.ui.rockfallChart.data.datasets[1].data = rainfall;
                AppState.ui.rockfallChart.data.datasets[2].data = crackWidth;
                AppState.ui.rockfallChart.update();
            },
            
            // CSV Upload functionality
            previewCSV: function() {
                const file = this.elements.csvFile.files[0];
                const mineId = this.elements.mineSelect.value;
                
                if (!file || !mineId) {
                    this.showNotification('Please select both a mine and a CSV file', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csvText = e.target.result;
                        const data = this.parseCSV(csvText);
                        
                        if (data.length === 0) {
                            this.showNotification('No valid data found in CSV file', 'error');
                            return;
                        }
                        
                        this.displayPreview(data.slice(0, 10)); // Show first 10 rows
                        this.elements.previewSection.style.display = 'block';
                        this.elements.confirmUploadBtn.style.display = 'inline-block';
                        
                    } catch (error) {
                        this.showNotification('Error parsing CSV: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            },
            
            parseCSV: function(csvText) {
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                if (lines.length < 2) {
                    throw new Error('CSV file is empty or has no data rows');
                }
                
                // Extract headers and normalize them
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/[^a-z0-9]/g, '_'));
                
                // Expected columns mapping
                const expectedColumns = ['rainfall', 'temperature', 'slope_angle', 'seismic_magnitude', 'crack_width', 'risk_score', 'risk_level'];
                
                // Validate headers
                const missingColumns = expectedColumns.filter(col => !headers.includes(col));
                if (missingColumns.length > 0) {
                    throw new Error(`Missing required columns: ${missingColumns.join(', ')}`);
                }
                
                // Parse data rows
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values.length === headers.length) {
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index];
                        });
                        
                        // Validate and convert data types
                        const validatedRow = this.validateRow(row);
                        if (validatedRow) {
                            data.push(validatedRow);
                        }
                    }
                }
                
                return data;
            },
            
            validateRow: function(row) {
                try {
                    // Convert numerical values
                    const rainfall = parseFloat(row.rainfall);
                    const temperature = parseFloat(row.temperature);
                    const slope_angle = parseFloat(row.slope_angle);
                    const seismic_magnitude = parseFloat(row.seismic_magnitude);
                    const crack_width = parseFloat(row.crack_width);
                    const risk_score = parseInt(row.risk_score);
                    
                    // Validate risk level
                    const risk_level = row.risk_level.toLowerCase();
                    if (!['low', 'medium', 'high'].includes(risk_level)) {
                        console.warn('Invalid risk level:', row.risk_level);
                        return null;
                    }
                    
                    // Check for valid numbers
                    if (isNaN(rainfall) || isNaN(temperature) || isNaN(slope_angle) || 
                        isNaN(seismic_magnitude) || isNaN(crack_width) || isNaN(risk_score)) {
                        console.warn('Invalid numerical values in row:', row);
                        return null;
                    }
                    
                    return {
                        rainfall,
                        temperature,
                        slope_angle,
                        seismic_magnitude,
                        crack_width,
                        risk_score,
                        risk_level
                    };
                } catch (error) {
                    console.warn('Error validating row:', error);
                    return null;
                }
            },
            
            displayPreview: function(data) {
                if (data.length === 0) {
                    this.elements.previewTable.innerHTML = '<p>No valid data to display</p>';
                    return;
                }
                
                const headers = Object.keys(data[0]);
                let html = `
                    <table class="preview-table">
                        <thead>
                            <tr>
                                ${headers.map(header => 
                                    `<th>${header.replace(/_/g, ' ').toUpperCase()}</th>`
                                ).join('')}
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.forEach(row => {
                    html += '<tr>';
                    headers.forEach(header => {
                        let value = row[header];
                        if (header === 'risk_level') {
                            value = `<span class="risk-badge ${value}">${value}</span>`;
                        } else if (typeof value === 'number') {
                            value = value.toFixed(2);
                        }
                        html += `<td>${value}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                this.elements.previewTable.innerHTML = html;
            },
            
            uploadCSV: function() {
                const file = this.elements.csvFile.files[0];
                const mineId = this.elements.mineSelect.value;
                
                if (!file || !mineId) {
                    this.showNotification('Please select both a mine and a CSV file', 'error');
                    return;
                }

                try {
                    this.elements.uploadProgress.style.display = 'block';
                    this.elements.uploadStatus.innerHTML = '';
                    
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const csvText = e.target.result;
                            const data = this.parseCSV(csvText);
                            
                            if (data.length === 0) {
                                throw new Error('No valid data found in CSV file');
                            }
                            
                            // Add mine_id and timestamp to each record
                            const records = data.map(record => ({
                                ...record,
                                mine_id: mineId,
                                recorded_at: new Date().toISOString()
                            }));
                            
                            // Simulate upload (in a real app, this would send to a server)
                            await this.simulateUpload(records);
                            
                        } catch (error) {
                            this.elements.uploadStatus.innerHTML = `<div class="upload-error">Error: ${error.message}</div>`;
                        }
                    };
                    reader.readAsText(file);
                    
                } catch (error) {
                    this.elements.uploadStatus.innerHTML = `<div class="upload-error">Error: ${error.message}</div>`;
                }
            },
            
            simulateUpload: async function(records) {
                // Simulate upload process with progress
                const totalRecords = records.length;
                let processed = 0;
                
                for (let i = 0; i < records.length; i += 10) {
                    // Simulate API call delay
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    processed = Math.min(i + 10, totalRecords);
                    const progress = (processed / totalRecords) * 100;
                    this.elements.progressBar.style.width = `${progress}%`;
                    this.elements.progressPercent.textContent = `${Math.round(progress)}%`;
                }
                
                // Add uploaded data to app state
                AppState.data.rockfall = [...AppState.data.rockfall, ...records];
                AppState.connections.rockfall = true;
                
                // Cache the data
                DataPersistence.saveData('rockfall', AppState.data.rockfall);
                
                this.elements.uploadStatus.innerHTML = `
                    <div class="upload-success">
                        Successfully uploaded ${records.length} records! 
                        <a href="#" onclick="API.fetchRockfallData(); return false;">Click here to refresh the data.</a>
                    </div>
                `;
                
                this.updateApiStatus();
                this.updateDashboardStats();
                this.displayRockfallData();
                this.updateRockfallChart();
                
                this.showNotification(`Successfully uploaded ${records.length} rockfall records`, 'success');
            },
            
            confirmUpload: function() {
                this.elements.previewSection.style.display = 'none';
                this.uploadCSV();
            },
            
            cancelPreview: function() {
                this.elements.previewSection.style.display = 'none';
                this.elements.confirmUploadBtn.style.display = 'none';
            }
        };

        // Initialize the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            UI.init();
            
            // Store original button texts for loading states
            document.querySelectorAll('.btn').forEach(btn => {
                btn.setAttribute('data-original-text', btn.innerHTML);
            });

            // Initialize error handler display
            ErrorHandler.updateErrorDisplay();
            
            // Add focus styles for keyboard navigation
            const style = document.createElement('style');
            style.textContent = `
                .keyboard-navigation .btn:focus,
                .keyboard-navigation input:focus,
                .keyboard-navigation select:focus,
                .keyboard-navigation .tab:focus,
                .keyboard-navigation .pref-tab:focus,
                .keyboard-navigation .theme-option:focus {
                    outline: 2px solid var(--brand) !important;
                    outline-offset: 2px !important;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>